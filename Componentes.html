<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Componentes Ativos - Louvor</title>
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #27ae60;
      --bg: #f4f7f6;
      /* Ajustado para o fundo do seu index */
      --glass: rgba(255, 255, 255, 0.85);
      --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--primary);
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding: 10px 15px;
      background: #fff;
      border-bottom: 1px solid #ddd;
      width: 100%;
      box-sizing: border-box;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
      flex-grow: 1;
      text-align: center;
    }

    .btn-update i {
      color: var(--accent);
    }

    .nav-btn {
      background: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      text-decoration: none;
    }

    /* --- DASHBOARD GLASS CARD --- */
    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }

    /* --- GRÁFICOS E KPIs --- */
    .bar-bg {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .bar-fill {
      height: 100%;
      width: 0;
      transition: width 1s ease;
      border-radius: 12px;
    }

    .bar-fill.masc {
      background: linear-gradient(90deg, #3498db, #2980b9);
    }

    .bar-fill.fem {
      background: linear-gradient(90deg, #e84393, #d63384);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 25px;
    }

    .kpi-card {
      background: var(--glass);
      border-radius: 18px;
      padding: 12px 5px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
    }

    .kpi-value {
      font-size: 1.3rem;
      font-weight: 800;
      display: block;
      margin-top: 5px;
    }

    /* --- CORES ÍCONES --- */
    i.Ministro {
      color: #3498db;
    }

    i.Back {
      color: #1abc9c;
    }

    i.Violão {
      color: #e67e22;
    }

    i.Guitarra {
      color: #e74c3c;
    }

    i.Baixo {
      color: #9b59b6;
    }

    i.Teclado {
      color: #f1c40f;
    }

    i.Bateria {
      color: #2ecc71;
    }

    /* --- GRID DE COMPONENTES --- */
    #listaComponentes {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 10px;
    }

    .comp-card {
      background: white;
      border-radius: 20px;
      padding: 20px 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.02);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .comp-card:active {
      transform: scale(0.96);
    }

    /* HOVER EFFECT (Igual Index) */
    .comp-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    /* KPI COMO FILTRO */
    .kpi-card {
      cursor: pointer;
      transition: all 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .kpi-card.active-filter {
      border: 2px solid var(--accent);
      background: white;
    }


    .avatar {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      border: 3px solid #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .comp-name {
      font-weight: 800;
      font-size: 0.9rem;
      color: var(--primary);
    }

    .comp-role {
      font-size: 0.7rem;
      color: #7f8c8d;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* --- MODAL ESTILO INDEX.HTML --- */
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-perfil {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      /* Centraliza verticalmente */
      justify-content: center;
      /* Centraliza horizontalmente */
      padding: 15px;
      box-sizing: border-box;
      backdrop-filter: blur(2px);
    }

    .modal-content-perfil {
      background: white;
      padding: 20px;
      border-radius: 15px;
      width: 100%;
      max-width: 400px;
      position: relative;
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .close-perfil {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #95a5a6;
    }

    .modal-header {
      border-bottom: 2px solid #f4f7f6;
      padding-bottom: 10px;
      margin-bottom: 15px;
      text-align: left;
    }

    .modal-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #95a5a6;
      margin: 15px 0 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: block;
    }

    /* Listas dentro do modal */
    .list-item {
      background: #f8f9fa;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      border-left: 4px solid var(--accent);
    }

    /* Botões de Ação no Modal */
    .action-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-icon {
      padding: 12px;
      border-radius: 10px;
      text-decoration: none;
      color: white;
      font-size: 0.85rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-tel {
      background: #3498db;
    }

    .btn-wpp {
      background: #25d366;
    }

    @media (min-width: 450px) {
      #listaComponentes {
        grid-template-columns: repeat(3, 1fr);
      }

      /* Filtros em Pílulas */
      .filter-container {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 10px 5px;
        margin-bottom: 15px;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .filter-pill {
        background: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #7f8c8d;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.3s;
      }

      .filter-pill.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(44, 62, 80, 0.2);
      }

      /* Efeito Shimmer (Skeleton) */
      .skeleton {
        background: #eee;
        background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
        border-radius: 20px;
        background-size: 200% 100%;
        animation: 1.5s shine linear infinite;
      }

      @keyframes shine {
        to {
          background-position-x: -200%;
        }
      }

      /* Melhoria no Modal para parecer mais limpo */
      .detail-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 8px;
      }
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    /* LIGHTBOX */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 20000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>

<div class="header-bar">
  <button class="nav-btn" onclick="window.location.href='index.html'" title="Voltar">
    <i class="fas fa-arrow-left"></i>
  </button>
  <div class="header-title">
    <h2><i class="fas fa-users"></i> Equipe</h2>
  </div>
  <button class="nav-btn btn-update" onclick="iniciar(true)" title="Atualizar Dados">
    <i class="fas fa-sync-alt"></i>
  </button>
</div>

<div class="container" style="padding: 20px 15px;">
  <div id="graficoGenero" class="glass-card">
    <!-- MASCULINO -->
    <div class="gender-bar-container" onclick="filtrarPorGenero('MASC', this)"
      style="cursor:pointer; margin-bottom:15px; transition:0.2s">
      <div class="bar-info" style="margin-bottom:5px; font-weight:bold; font-size:0.85rem">
        <span id="txtMasc">Masculino - 0% (0)</span>
      </div>
      <div class="bar-bg">
        <div id="barMasc" class="bar-fill masc"></div>
      </div>
    </div>

    <!-- FEMININO -->
    <div class="gender-bar-container" onclick="filtrarPorGenero('FEM', this)" style="cursor:pointer; transition:0.2s">
      <div class="bar-info" style="margin-bottom:5px; font-weight:bold; font-size:0.85rem">
        <span id="txtFem">Feminino - 0% (0)</span>
      </div>
      <div class="bar-bg">
        <div id="barFem" class="bar-fill fem"></div>
      </div>
    </div>
  </div>

  <div id="kpiFuncoes" class="kpi-grid"></div>
  <!-- OS FILTROS DE PÍLULA FORAM REMOVIDOS E INTEGRADOS AOS KPIs -->
  <div id="listaComponentes">
    <div id="loader" style="display:none; text-align:center; padding:50px;">
      <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--accent)"></i>
      <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">Sincronizando equipe...</p>
    </div>
  </div>
</div>

<script>
  /* AS FUNÇÕES ABAIXO PERMANECERAM IGUAIS, APENAS COM AJUSTES NO INNERHTML PARA O NOVO DESIGN */
  const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;
  let bancoImagens = [];
  let dadosMembros = [];

  async function iniciar(force = false) {
    const loader = document.getElementById('loader');
    const cachedComp = localStorage.getItem('offline_componentes');
    const cachedImg = localStorage.getItem('offline_imagens');

    if (!force && cachedComp && cachedImg) {
      bancoImagens = JSON.parse(cachedImg);
      const ativos = JSON.parse(cachedComp).filter(c =>
        c.Ativo &&
        c.Ativo.toString().toUpperCase().trim() === "SIM" &&
        !c.Função.toUpperCase().includes("CONVIDADO") &&
        !c.Nome.toUpperCase().includes("CONVIDADO")
      );
      dadosMembros = ativos;
      atualizarDashboards(ativos);
      renderizar(ativos);
      return;
    }

    const btnIcon = document.querySelector('.btn-update i');
    if (btnIcon) btnIcon.classList.add('spin');

    loader.style.display = 'block';
    try {
      const [resComp, resImg] = await Promise.all([
        fetch(SCRIPT_URL + "?sheet=Componentes"),
        fetch(SCRIPT_URL + "?action=getImages")
      ]);
      const dataComp = await resComp.json();
      const dataImg = await resImg.json();

      bancoImagens = dataImg.data;
      localStorage.setItem('offline_imagens', JSON.stringify(dataImg.data));

      // FILTRO GLOBAL DE CONVIDADOS
      const ativos = dataComp.data.filter(c =>
        c.Ativo &&
        c.Ativo.toString().toUpperCase().trim() === "SIM" &&
        !c.Função.toUpperCase().includes("CONVIDADO") &&
        !c.Nome.toUpperCase().includes("CONVIDADO")
      );
      dadosMembros = ativos;
      localStorage.setItem('offline_componentes', JSON.stringify(ativos));

      loader.style.display = 'none';
      atualizarDashboards(ativos);
      renderizar(ativos);
    } catch (e) {
      console.error(e);
      loader.innerText = "Erro ao carregar dados.";
    } finally {
      if (btnIcon) btnIcon.classList.remove('spin');
    }
  }

  function atualizarDashboards(ativos) {
    gerarKpisFuncoes(ativos);
    gerarGraficoGenero(ativos);
  }

  function gerarKpisFuncoes(lista) {
    const iconsMap = {
      "Ministro": "fa-microphone-lines",
      "Back": "fa-microphone",
      "Violão": "fa-guitar",
      "Guitarra": "fa-guitar",
      "Teclado": "fa-keyboard",
      "Baixo": "fa-guitar",
      "Bateria": "fa-drum",
    };

    const counts = {};
    Object.keys(iconsMap).forEach(f => counts[f] = 0);

    lista.forEach(p => {
      const funcaoCol = (p.Função || "").toUpperCase();
      // Convidado já removido globalmente, mas mantemos segurança
      if (funcaoCol.includes("CONVIDADO")) return;
      Object.keys(iconsMap).forEach(f => {
        if (funcaoCol.includes(f.toUpperCase())) counts[f]++;
      });
    });

    const container = document.getElementById("kpiFuncoes");

    // Card TODOS
    let html = `
        <div class="kpi-card active-filter" onclick="filtrarPorFuncao('TODOS', this)">
            <div class="kpi-icon"><i class="fas fa-users" style="color:var(--primary)"></i></div>
            <div class="kpi-value">${lista.length}</div>
            <div class="kpi-label">Todos</div>
        </div>
      `;

    html += Object.entries(iconsMap).map(([nome, icone]) => `
        <div class="kpi-card" onclick="filtrarPorFuncao('${nome.toUpperCase()}', this)">
          <div class="kpi-icon"><i class="fas ${icone} ${nome}"></i></div>
          <div class="kpi-value">${counts[nome]}</div>
          <div class="kpi-label">${nome}</div>
        </div>
      `).join('');

    container.innerHTML = html;
  }

  function gerarGraficoGenero(lista) {
    let masc = 0, fem = 0;
    lista.forEach(p => {
      // Tenta várias colunas comuns
      const g = (p.Genero || p["Gênero"] || p.Sexo || "").toString().toUpperCase().trim();
      if (g.includes("HOMEM") || g.includes("MASC") || g === "M") masc++;
      else if (g.includes("MULHER") || g.includes("FEM") || g === "F") fem++;
    });

    const total = masc + fem || 1;
    const pMasc = Math.round((masc / total) * 100);
    const pFem = Math.round((fem / total) * 100);

    const bMasc = document.getElementById('barMasc');
    const tMasc = document.getElementById('txtMasc');
    const bFem = document.getElementById('barFem');
    const tFem = document.getElementById('txtFem');

    if (bMasc && tMasc) {
      bMasc.style.width = pMasc + "%";
      tMasc.innerText = `Masculino - ${pMasc}% (${masc})`;
    }
    if (bFem && tFem) {
      bFem.style.width = pFem + "%";
      tFem.innerText = `Feminino - ${pFem}% (${fem})`;
    }
  }

  // 2. Nova função para abrir o modal e carregar os dados
  function abrirDetalhes(nome, foto, funcao, tel, wpp) {
    const modal = document.getElementById('modalPerfilComp');
    modal.style.display = 'flex';

    // Cabeçalho alinhado à esquerda com foto pequena ao lado ou centralizada
    document.getElementById('detalheCabecalho').innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="${foto}" style="width:60px; height:60px; border-radius:12px; object-fit:cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <div>
                <h3 style="margin:0; font-size: 1.1rem; color: #2c3e50;">${nome}</h3>
                <small style="color: #7f8c8d; font-weight: 600;">${funcao}</small>
            </div>
        </div>
    `;

    // Botões de ação no padrão do app
    document.getElementById('modalAcoes').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <a href="tel:${tel}" class="btn-icon btn-tel" style="border-radius:10px; padding:10px;"><i class="fas fa-phone"></i> Ligar</a>
            <a href="${wpp}" target="_blank" class="btn-icon btn-wpp" style="border-radius:10px; padding:10px;"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        </div>
    `;

    // Inicia buscas nos boxes do modal
    buscarEscalasNoModal(nome);
    buscarHistoricoNoModal(nome, funcao);
    buscarAvisosGeraisNoModal(nome);
  }

  // Busca Escalas focada no Modal (CORRIGIDA)
  async function buscarEscalasNoModal(nome) {
    const box = document.getElementById('modalEscalas');
    box.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc;">Carregando...</div>';

    try {
      const cached = localStorage.getItem('offline_escala');
      if (!cached) {
        box.innerHTML = "<small>Sem dados offline.</small>";
        return;
      }

      const data = JSON.parse(cached);
      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

      const filtrado = data
        .filter(e => {
          const d = new Date(e.Data);
          return e.Nome && e.Nome.toLowerCase().trim() === nome.toLowerCase().trim() && d >= hoje;
        })
        .sort((a, b) => new Date(a.Data) - new Date(b.Data))
        .slice(0, 3);

      if (filtrado.length > 0) {
        box.innerHTML = filtrado.map(e => `
            <div class="list-item">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:700; color:#2c3e50;">${new Date(e.Data).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</span>
                    <span style="font-size:0.8rem; color:#7f8c8d;">${e["Nome dos Cultos"]}</span>
                </div>
                <small style="color:var(--accent); font-weight:600;">${e.Função}</small>
            </div>
            `).join('');
      } else {
        box.innerHTML = '<div style="padding:10px; text-align:center; color:#95a5a6; font-size:0.8rem;">Nenhuma escala futura.</div>';
      }
    } catch (e) { box.innerHTML = "Erro ao carregar."; console.log(e); }
  }

  // Busca Histórico focado no Modal (CORRIGIDA)
  async function buscarHistoricoNoModal(nome, funcao) {
    const box = document.getElementById('modalHistorico');

    const f = funcao.toUpperCase();
    const container = document.getElementById('modalHistoricoContainer');
    if (!f.includes("MINISTRO") && !f.includes("BACK")) {
      container.style.display = 'none';
      return;
    }
    container.style.display = 'block';

    box.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc;">Carregando...</div>';

    try {
      const cached = localStorage.getItem('offline_historico');
      const data = cached ? JSON.parse(cached) : [];

      // Filtra pelo cantor
      const hist = data.filter(h => h.Cantor && h.Cantor.toLowerCase().trim() === nome.toLowerCase().trim());

      // Pega os últimos 5
      const ultimos = hist.reverse().slice(0, 5);

      if (ultimos.length > 0) {
        box.innerHTML = ultimos.map(h => `
            <div class="list-item" style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:600; font-size:0.8rem; color:#333;">${h.Música || h.Músicas}</span>
                <span style="color:#9b59b6; font-weight:bold; font-size:0.75rem;">${h.Tom || h.Tons || ''}</span>
            </div>
            `).join('');
      } else {
        box.innerHTML = '<div style="padding:10px; text-align:center; color:#95a5a6; font-size:0.8rem;">Nenhum registro recente.</div>';
      }
    } catch (e) { box.innerHTML = "Erro ao carregar."; }
  }

  function renderizar(lista) {
    const container = document.getElementById('listaComponentes');
    container.innerHTML = ''; // Limpa o container

    // Filtra para remover convidados
    const listaFiltrada = lista.filter(item => {
      const funcao = (item.Função || "").toUpperCase();
      const nome = (item.Nome || "").toUpperCase();
      return !funcao.includes("CONVIDADO") && !nome.includes("CONVIDADO");
    });

    container.innerHTML = listaFiltrada.map(item => {
      const nomeLimpo = item.Nome.trim();
      const nomeArquivo = item.Foto ? item.Foto.split('/').pop() : "";
      const fotoObj = bancoImagens.find(img => img.nome === nomeArquivo);
      const urlFoto = fotoObj ? fotoObj.url : "https://via.placeholder.com/150";

      return `
      <div class="comp-card" onclick="abrirDetalhes('${nomeLimpo}', '${urlFoto}', '${item.Função}', '${item["Tel sem Espaço"]}', '${item.Whatsapp?.link || '#'}')">
        <div class="avatar-wrapper">
          <img src="${urlFoto}" class="avatar" onclick="abrirFotoExpandida('${urlFoto}', event)" title="Clique para ampliar">
        </div>
        <div class="comp-name">${nomeLimpo}</div>
        <div class="comp-role">${item.Função}</div>
      </div>
    `;
    }).join('');
  }
  function fecharModalDetalhes(e) {
    if (e.target.id === 'modalPerfilComp') {
      document.getElementById('modalPerfilComp').style.display = 'none';
    }
  }
  function filtrarPorFuncao(categoria, elemento) {
    // Reset visual do filtro de genero
    document.querySelectorAll('.gender-bar-container').forEach(p => {
      p.style.opacity = '1';
      p.style.transform = 'scale(1)';
    });

    // UI: Troca a classe active no elemento clicado (agora é o card)
    document.querySelectorAll('.kpi-card').forEach(p => p.classList.remove('active-filter'));
    if (elemento) elemento.classList.add('active-filter');

    // Lógica: Filtra a lista original
    if (categoria === 'TODOS') {
      renderizar(dadosMembros);
    } else {
      const filtrados = dadosMembros.filter(m =>
        m.Função.toUpperCase().includes(categoria)
      );
      renderizar(filtrados);
    }
  }

  function filtrarPorGenero(genero, elemento) {
    // Reset visual dos KPIs
    document.querySelectorAll('.kpi-card').forEach(p => p.classList.remove('active-filter'));

    // UI: Feedback visual na barra clicada
    document.querySelectorAll('.gender-bar-container').forEach(p => {
      p.style.opacity = '0.4';
      p.style.transform = 'scale(0.98)';
    });
    if (elemento) {
      elemento.style.opacity = '1';
      elemento.style.transform = 'scale(1.02)';
    }

    const filtrados = dadosMembros.filter(m => {
      const g = (m.Genero || m["Gênero"] || "").toString().toUpperCase().trim();
      if (genero === 'MASC') return g.includes("HOMEM") || g.includes("MASC");
      return g.includes("MULHER") || g.includes("FEM");
    });
    renderizar(filtrados);
  }
  async function buscarAvisosGeraisNoModal(nome) {
    const container = document.getElementById('modalAvisosGeraisContainer');
    const box = document.getElementById('modalAvisosGerais');
    const userToken = JSON.parse(localStorage.getItem('user_token') || '{}');
    const isAdmin = userToken.Role === "Admin" || userToken.Role === "SuperAdmin";

    if (!isAdmin) {
      container.style.display = 'none';
      return;
    }

    box.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc;">Carregando...</div>';

    try {
      const cached = localStorage.getItem('offline_lembretes');
      const lembretes = cached ? JSON.parse(cached) : [];

      const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
      const nomeNormalizado = normalize(nome);

      const avisos = lembretes.filter(l =>
        l.Culto === "Aviso Geral" &&
        (normalize(l.Componente).includes(nomeNormalizado) || nomeNormalizado.includes(normalize(l.Componente)))
      );

      if (avisos.length > 0) {
        container.style.display = 'block';
        box.innerHTML = avisos.map(a => `
          <div style="background:#fffafa; border-left:3px solid #e67e22; padding:8px; border-radius:5px; margin-top:8px; font-size:0.8rem; position:relative;">
            <div style="font-weight:bold; margin-bottom:3px; display:flex; justify-content:space-between;">
              <span>${a.Componente}</span>
              <span style="font-size:0.7rem; color:#95a5a6;">${a.Data}</span>
            </div>
            <div style="color:#555;">${a.Info}</div>
            <i class="fas fa-trash-alt" onclick="excluirAviso('${a.id_Lembrete}', event)" style="position:absolute; right:8px; bottom:8px; color:#ddd; cursor:pointer; font-size:0.75rem;" title="Remover"></i>
          </div>
        `).join('');
      } else {
        container.style.display = 'none';
      }
    } catch (e) { console.log(e); }
  }

  async function excluirAviso(id, event) {
    if (event) event.stopPropagation();
    if (!confirm("Deseja realmente excluir este aviso?")) return;

    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: "delete", sheet: "Lembretes", id_Lembrete: id })
      });
      const res = await response.json();
      if (res.status === "success") {
        alert("Aviso excluído!");
        // Atualiza localmente
        let lembretes = JSON.parse(localStorage.getItem('offline_lembretes') || '[]');
        lembretes = lembretes.filter(l => l.id_Lembrete !== id);
        localStorage.setItem('offline_lembretes', JSON.stringify(lembretes));

        // Recarrega se o modal ainda estiver aberto
        const modal = document.getElementById('modalPerfilComp');
        if (modal.style.display === 'flex') {
          // Aqui precisaria do nome, mas vamos apenas sumir com o item do DOM pra ser mais rápido
          const el = event.target.closest('div');
          if (el) el.remove();
        }
      } else {
        alert("Erro ao excluir: " + res.message);
      }
    } catch (e) { alert("Erro de conexão."); }
  }

  function abrirFotoExpandida(url, event) {
    if (event) event.stopPropagation();
    const lb = document.getElementById('lightbox');
    const img = document.getElementById('lightboxImg');
    img.src = url;
    lb.style.display = 'flex';
  }

  function fecharLightbox() {
    document.getElementById('lightbox').style.display = 'none';
  }

  window.onload = () => iniciar();
</script>

<div id="lightbox" class="lightbox" onclick="fecharLightbox()">
  <img id="lightboxImg" src="">
</div>

<div id="modalPerfilComp" class="modal-perfil" onclick="fecharModalDetalhesExterno(event)">
  <div class="modal-content-perfil" onclick="event.stopPropagation()">
    <span class="close-perfil" onclick="document.getElementById('modalPerfilComp').style.display='none'">&times;</span>

    <div class="modal-header">
      <div id="detalheCabecalho">
      </div>
    </div>

    <div style="text-align: left;">
      <small style="color: #e67e22; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
        <i class="fas fa-calendar-alt"></i> Próximas Escalas
      </small>
      <div id="modalEscalas" style="margin-bottom: 20px;"></div>

      <div id="modalHistoricoContainer" style="display:none; margin-bottom: 20px;">
        <small style="color: #9b59b6; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
          <i class="fas fa-music"></i> Histórico (Voz)
        </small>
        <div id="modalHistorico"></div>
      </div>

      <div id="modalAvisosGeraisContainer" style="display:none; margin-top:20px;">
        <small style="color: #e67e22; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
          <i class="fas fa-bullhorn"></i> Avisos Gerais
        </small>
        <div id="modalAvisosGerais"></div>
      </div>
    </div>

    <div id="modalAcoes" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;"></div>
  </div>
</div>


</div>
</body>

</html>