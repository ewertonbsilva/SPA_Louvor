<!DOCTYPE html>
<html lang="pt-br">

<head>
  <script src="temas-lista.js"></script>
  <script src="temas-core.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Componentes Ativos - Louvor</title>
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <style>
    body {
      padding-top: 80px;
    }

    :root {
      --primary: #2c3e50;
      --accent: #27ae60;
      --bg: #f4f7f6;
      /* Ajustado para o fundo do seu index */
      --glass: rgba(255, 255, 255, 0.85);
      --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--primary);
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header-bar {
      background: var(--glass);
      backdrop-filter: blur(12px);
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .header-left-nav,
    .header-right-nav {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      flex-grow: 1;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-btn {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      cursor: pointer;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      font-size: 1.2rem;
      padding: 10px;
      text-decoration: none;
    }

    .nav-btn:active {
      transform: scale(0.9);
    }

    /* THEME PANEL */
    .theme-panel {
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 24px;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      z-index: 10001;
      max-width: 240px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.05);
      animation: slideIn 0.3s ease-out;
    }

    .theme-panel h3 {
      margin-top: 0;
      font-weight: 800;
      font-size: 1rem;
      color: #000 !important;
    }

    .theme-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .theme-btn-circ {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: 0.3s;
    }

    .theme-btn-circ.active {
      border-color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
    }

    .apply-btn {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }

    @keyframes slideIn {
      from {
        transform: translateX(50px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* --- DASHBOARD GLASS CARD --- */
    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }

    /* --- GRÃFICOS E KPIs --- */
    .bar-bg {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .bar-fill {
      height: 100%;
      width: 0;
      transition: width 1s ease;
      border-radius: 12px;
    }

    .bar-fill.masc {
      background: linear-gradient(90deg, #3498db, #2980b9);
    }

    .bar-fill.fem {
      background: linear-gradient(90deg, #e84393, #d63384);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 25px;
    }

    .kpi-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 15px 5px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.02);
      transition: all 0.2s;
    }

    .kpi-value {
      font-size: 1.3rem;
      font-weight: 800;
      display: block;
      margin-top: 5px;
    }

    /* --- CORES ÃCONES --- */
    i.Ministro {
      color: #3498db;
    }

    i.Back {
      color: #1abc9c;
    }

    i.Violão {
      color: #e67e22;
    }

    i.Guitarra {
      color: #e74c3c;
    }

    i.Baixo {
      color: #9b59b6;
    }

    i.Teclado {
      color: #f1c40f;
    }

    i.Bateria {
      color: #2ecc71;
    }

    /* --- GRID DE COMPONENTES --- */
    #listaComponentes {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 10px;
    }

    .comp-card {
      background: white;
      border-radius: 20px;
      padding: 20px 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.02);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .comp-card:active {
      transform: scale(0.96);
    }

    /* HOVER EFFECT (Igual Index) */
    .comp-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    /* KPI COMO FILTRO */
    .kpi-card {
      cursor: pointer;
      transition: all 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .kpi-card.active-filter {
      border: 2px solid var(--accent);
      background: white;
    }


    .avatar {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      border: 3px solid #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .comp-name {
      font-weight: 800;
      font-size: 0.9rem;
      color: var(--primary);
    }

    .comp-role {
      font-size: 0.7rem;
      color: #7f8c8d;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* --- MODAL ESTILO INDEX.HTML --- */
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-perfil {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      padding: 15px;
      box-sizing: border-box;
    }

    .modal-content-perfil {
      background: white;
      padding: 30px;
      border-radius: 24px;
      width: 100%;
      max-width: 400px;
      position: relative;
      animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
    }

    @keyframes modalPop {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .close-perfil {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #94a3b8;
      transition: 0.2s;
      z-index: 1;
    }

    .close-perfil:hover {
      color: #1e293b;
    }

    .modal-header {
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 15px;
      margin-bottom: 20px;
      text-align: left;
    }

    .modal-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #64748b;
      margin: 15px 0 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: block;
    }

    /* Listas dentro do modal */
    .list-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      border-left: 4px solid var(--accent);
      transition: 0.2s;
    }

    .list-item:hover {
      background: #f1f5f9;
    }

    /* BotÃµes de AÃ§Ã£o no Modal */
    .action-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-icon {
      padding: 12px;
      border-radius: 10px;
      text-decoration: none;
      color: white;
      font-size: 0.85rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-tel {
      background: #3498db;
    }

    .btn-wpp {
      background: #25d366;
    }

    @media (min-width: 450px) {
      #listaComponentes {
        grid-template-columns: repeat(3, 1fr);
      }

      /* Filtros em Pílulas */
      .filter-container {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 10px 5px;
        margin-bottom: 15px;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .filter-pill {
        background: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #7f8c8d;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.3s;
      }

      .filter-pill.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(44, 62, 80, 0.2);
      }

      /* Efeito Shimmer (Skeleton) */
      .skeleton {
        background: #eee;
        background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
        border-radius: 20px;
        background-size: 200% 100%;
        animation: 1.5s shine linear infinite;
      }

      @keyframes shine {
        to {
          background-position-x: -200%;
        }
      }

      /* Melhoria no Modal para parecer mais limpo (Premium Style) */
      .detail-item {
        background: #fdf2e9;
        /* Light orange tint common in music themes */
        padding: 15px;
        border-radius: 18px;
        margin-bottom: 12px;
        border-left: 5px solid #e67e22;
        /* Primary accent */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .detail-item:hover {
        transform: translateX(5px);
        background: #fff;
      }

      .detail-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .detail-culto {
        font-weight: 800;
        color: #1e293b;
        font-size: 0.95rem;
      }

      .detail-date {
        font-size: 0.75rem;
        background: rgba(230, 126, 34, 0.1);
        color: #e67e22;
        padding: 4px 10px;
        border-radius: 10px;
        font-weight: 700;
      }

      .detail-funcoes {
        font-size: 0.8rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }

      .detail-funcoes i {
        color: #e67e22;
      }
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    /* LIGHTBOX */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 20000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>

<body>

  <div class="header-bar">
    <div class="header-left-nav">
      <i class="fas fa-arrow-left nav-btn" onclick="history.back()" title="Voltar"></i>
      <i class="fas fa-home nav-btn" onclick="window.location.href='index.html'" title="Início"></i>
    </div>
    <h2 class="header-title">Equipe</h2>
    <div class="header-right-nav">
      <i class="fas fa-palette nav-btn" onclick="toggleThemePanel()" title="Trocar Tema"></i>
      <i class="fas fa-sync-alt nav-btn" onclick="iniciar(true)" title="Sincronizar"></i>
    </div>
  </div>

  <div id="themePanel" class="theme-panel">
    <h3>Escolha um Tema</h3>
    <div class="theme-buttons" id="themeButtonsGrid"></div>
    <button class="apply-btn" onclick="confirmarTema()">USAR ESTE TEMA</button>
  </div>

  <div class="premium-container">
    <div id="graficoGenero" class="premium-card">
      <!-- MASCULINO -->
      <div class="gender-bar-container" onclick="filtrarPorGenero('MASC', this)"
        style="cursor:pointer; margin-bottom:15px; transition:0.2s">
        <div class="bar-info" style="margin-bottom:5px; font-weight:bold; font-size:0.85rem">
          <span id="txtMasc">Masculino - 0% (0)</span>
        </div>
        <div class="bar-bg">
          <div id="barMasc" class="bar-fill masc"></div>
        </div>
      </div>

      <!-- FEMININO -->
      <div class="gender-bar-container" onclick="filtrarPorGenero('FEM', this)" style="cursor:pointer; transition:0.2s">
        <div class="bar-info" style="margin-bottom:5px; font-weight:bold; font-size:0.85rem">
          <span id="txtFem">Feminino - 0% (0)</span>
        </div>
        <div class="bar-bg">
          <div id="barFem" class="bar-fill fem"></div>
        </div>
      </div>
    </div>

    <div id="kpiFuncoes" class="kpi-grid"></div>
    <!-- OS FILTROS DE PÃLULA FORAM REMOVIDOS E INTEGRADOS AOS KPIs -->
    <div id="listaComponentes">
      <div id="loader" style="display:none; text-align:center; padding:50px;">
        <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--accent)"></i>
        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">Sincronizando equipe...</p>
      </div>
    </div>
  </div>

  <script>
    /* AS FUNÇÕES ABAIXO PERMANECERAM IGUAIS, APENAS COM AJUSTES NO INNERHTML PARA O NOVO DESIGN */
    const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;
    let bancoImagens = [];
    let dadosMembros = [];

    async function iniciar(force = false) {
      const loader = document.getElementById('loader');
      const cachedComp = localStorage.getItem('offline_componentes');
      const cachedImg = localStorage.getItem('offline_imagens');

      if (!force && cachedComp && cachedImg) {
        bancoImagens = JSON.parse(cachedImg);
        const ativos = JSON.parse(cachedComp).filter(c => {
          const funcao = (c.Função || c.Função || c["FunÃ§Ã£o"] || "").toUpperCase();
          const nome = (c.Nome || "").toUpperCase();
          return c.Ativo &&
            c.Ativo.toString().toUpperCase().trim() === "SIM" &&
            !funcao.includes("CONVIDADO") &&
            !nome.includes("CONVIDADO");
        });
        dadosMembros = ativos;
        atualizarDashboards(ativos);
        renderizar(ativos);
        return;
      }

      const btnIcon = document.querySelector('.btn-update i');
      if (btnIcon) btnIcon.classList.add('spin');

      loader.style.display = 'block';
      try {
        const [resComp, resImg] = await Promise.all([
          fetch(SCRIPT_URL + "?sheet=Componentes"),
          fetch(SCRIPT_URL + "?action=getImages")
        ]);
        const dataComp = await resComp.json();
        const dataImg = await resImg.json();

        bancoImagens = dataImg.data;
        localStorage.setItem('offline_imagens', JSON.stringify(dataImg.data));

        // FILTRO GLOBAL DE CONVIDADOS
        const ativos = dataComp.data.filter(c => {
          const funcao = (c["Função"] || c["Função"] || c["FunÃ§Ã£o"] || "").toUpperCase();
          const nome = (c.Nome || "").toUpperCase();
          return c.Ativo &&
            c.Ativo.toString().toUpperCase().trim() === "SIM" &&
            !funcao.includes("CONVIDADO") &&
            !nome.includes("CONVIDADO");
        });
        dadosMembros = ativos;
        localStorage.setItem('offline_componentes', JSON.stringify(ativos));

        loader.style.display = 'none';
        atualizarDashboards(ativos);
        renderizar(ativos);
      } catch (e) {
        console.error(e);
        loader.innerText = "Erro ao carregar dados.";
      } finally {
        if (btnIcon) btnIcon.classList.remove('spin');
      }
    }

    function atualizarDashboards(ativos) {
      gerarKpisFuncoes(ativos);
      gerarGraficoGenero(ativos);
    }

    function gerarKpisFuncoes(lista) {
      const iconsMap = {
        "Ministro": "fa-microphone-lines",
        "Back": "fa-microphone",
        "Violão": "fa-guitar",
        "Guitarra": "fa-guitar",
        "Teclado": "fa-keyboard",
        "Baixo": "fa-guitar",
        "Bateria": "fa-drum",
      };

      const counts = {};
      Object.keys(iconsMap).forEach(f => counts[f] = 0);

      lista.forEach(p => {
        const funcaoCol = (p["Função"] || p["FunÃ§Ã£o"] || "").toUpperCase();
        // Convidado jÃ¡ removido globalmente, mas mantemos seguranÃ§a
        if (funcaoCol.includes("CONVIDADO")) return;
        Object.keys(iconsMap).forEach(f => {
          if (funcaoCol.includes(f.toUpperCase())) counts[f]++;
        });
      });

      const container = document.getElementById("kpiFuncoes");

      // Card TODOS
      let html = `
        <div class="kpi-card active-filter" onclick="filtrarPorFuncao('TODOS', this)">
            <div class="kpi-icon"><i class="fas fa-users" style="color:var(--primary)"></i></div>
            <div class="kpi-value">${lista.length}</div>
            <div class="kpi-label">Todos</div>
        </div>
      `;

      html += Object.entries(iconsMap).map(([nome, icone]) => `
        <div class="kpi-card" onclick="filtrarPorFuncao('${nome.toUpperCase()}', this)">
          <div class="kpi-icon"><i class="fas ${icone} ${nome}"></i></div>
          <div class="kpi-value">${counts[nome]}</div>
          <div class="kpi-label">${nome}</div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function gerarGraficoGenero(lista) {
      let masc = 0, fem = 0;
      lista.forEach(p => {
        // Tenta vÃ¡rias colunas comuns
        const g = (p.Genero || p["Gênero"] || p["GÃªnero"] || p.Sexo || "").toString().toUpperCase().trim();
        if (g.includes("HOMEM") || g.includes("MASC") || g === "M") masc++;
        else if (g.includes("MULHER") || g.includes("FEM") || g === "F") fem++;
      });

      const total = masc + fem || 1;
      const pMasc = Math.round((masc / total) * 100);
      const pFem = Math.round((fem / total) * 100);

      const bMasc = document.getElementById('barMasc');
      const tMasc = document.getElementById('txtMasc');
      const bFem = document.getElementById('barFem');
      const tFem = document.getElementById('txtFem');

      if (bMasc && tMasc) {
        bMasc.style.width = pMasc + "%";
        tMasc.innerText = `Masculino - ${pMasc}% (${masc})`;
      }
      if (bFem && tFem) {
        bFem.style.width = pFem + "%";
        tFem.innerText = `Feminino - ${pFem}% (${fem})`;
      }
    }

    // 2. Nova função para abrir o modal e carregar os dados
    function abrirDetalhes(nome, foto, funcao, tel, wpp) {
      const modal = document.getElementById('modalPerfilComp');
      modal.style.display = 'flex';

      // Cabeçalho alinhado à esquerda com foto pequena ao lado ou centralizada
      document.getElementById('detalheCabecalho').innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="${foto}" style="width:60px; height:60px; border-radius:12px; object-fit:cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <div>
                <h3 style="margin:0; font-size: 1.1rem; color: #2c3e50;">${nome}</h3>
                <small style="color: #7f8c8d; font-weight: 600;">${funcao}</small>
            </div>
        </div>
    `;

      // Botões de ação no padrão do app
      document.getElementById('modalAcoes').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <a href="tel:${tel}" class="btn-icon btn-tel" style="border-radius:10px; padding:10px;"><i class="fas fa-phone"></i> Ligar</a>
            <a href="${wpp}" target="_blank" class="btn-icon btn-wpp" style="border-radius:10px; padding:10px;"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        </div>
    `;

      // Inicia buscas nos boxes do modal
      buscarEscalasNoModal(nome);
      buscarHistoricoNoModal(nome, funcao);
      buscarAvisosGeraisNoModal(nome);
    }

    // Busca Escalas focada no Modal (CORRIGIDA)
    async function buscarEscalasNoModal(nome) {
      const box = document.getElementById('modalEscalas');
      box.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc;">Carregando...</div>';

      try {
        const cached = localStorage.getItem('offline_escala');
        if (!cached) {
          box.innerHTML = "<small>Sem dados offline.</small>";
          return;
        }

        const data = JSON.parse(cached);
        const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

        const filtrado = data
          .filter(e => {
            const d = new Date(e.Data);
            return e.Nome && e.Nome.toLowerCase().trim() === nome.toLowerCase().trim() && d >= hoje;
          })
          .sort((a, b) => new Date(a.Data) - new Date(b.Data))
          .slice(0, 3);

        if (filtrado.length > 0) {
          box.innerHTML = filtrado.map(e => `
            <div class="detail-item">
              <div class="detail-top">
                <span class="detail-culto">${e["Nome dos Cultos"]}</span>
                <span class="detail-date">${new Date(e.Data).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</span>
              </div>
              <span class="detail-funcoes"><i class="fas fa-tag"></i> ${e.Função}</span>
            </div>
          `).join('');
        } else {
          box.innerHTML = '<div style="padding:10px; text-align:center; color:#95a5a6; font-size:0.8rem;">Nenhuma escala futura.</div>';
        }
      } catch (e) { box.innerHTML = "Erro ao carregar."; console.log(e); }
    }

    // Busca Histórico focado no Modal (CORRIGIDA)
    async function buscarHistoricoNoModal(nome, funcao) {
      const box = document.getElementById('modalHistorico');

      const f = funcao.toUpperCase();
      const container = document.getElementById('modalHistoricoContainer');
      if (!f.includes("MINISTRO") && !f.includes("BACK")) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';

      box.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc;">Carregando...</div>';

      try {
        const cached = localStorage.getItem('offline_historico');
        const data = cached ? JSON.parse(cached) : [];

        // Filtra pelo cantor
        const hist = data.filter(h => h.Cantor && h.Cantor.toLowerCase().trim() === nome.toLowerCase().trim());

        // Pega os Ãºltimos 5
        const ultimos = hist.reverse().slice(0, 5);

        if (ultimos.length > 0) {
          box.innerHTML = ultimos.map(h => {
            const mNome = h.Músicas || h.Musica || h.Música || h.MÃºsica || h.MÃºsicas || 'Sem Título';
            const mTom = h.Tom || h.Tons || h.tom || '';
            return `
              <div class="detail-item">
                <div class="detail-top">
                  <span class="detail-culto">${mNome}</span>
                  <span class="detail-date" style="background:rgba(155, 89, 182, 0.1); color:#9b59b6;">${mTom}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          box.innerHTML = '<div style="padding:10px; text-align:center; color:#95a5a6; font-size:0.8rem;">Nenhum registro recente.</div>';
        }
      } catch (e) { box.innerHTML = "Erro ao carregar."; }
    }

    function renderizar(lista) {
      const container = document.getElementById('listaComponentes');
      container.innerHTML = ''; // Limpa o container

      // Filtra para remover convidados
      const listaFiltrada = lista.filter(item => {
        const funcao = (item["Função"] || item["Função"] || item["FunÃ§Ã£o"] || "").toUpperCase();
        const nome = (item.Nome || "").toUpperCase();
        return !funcao.includes("CONVIDADO") && !nome.includes("CONVIDADO");
      });

      container.innerHTML = listaFiltrada.map(item => {
        const nomeLimpo = item.Nome.trim();
        const nomeArquivo = item.Foto ? item.Foto.split('/').pop() : "";
        const fotoObj = bancoImagens.find(img => img.nome === nomeArquivo);
        const urlFoto = fotoObj ? fotoObj.url : "https://via.placeholder.com/150";

        return `
      <div class="premium-card text-center" style="padding: 20px 10px; cursor: pointer;" onclick="abrirDetalhes('${nomeLimpo}', '${urlFoto}', '${item.Função}', '${item["Tel sem Espaço"]}', '${item.Whatsapp?.link || '#'}')">
        <div class="avatar-wrapper">
          <img src="${urlFoto}" class="avatar" onclick="abrirFotoExpandida('${urlFoto}', event)" title="Clique para ampliar" style="width: 70px; height: 70px; border-radius: 20px; border: none; box-shadow: var(--shadow-md);">
        </div>
        <div class="comp-name font-heading" style="font-size: 0.95rem; margin-top: 5px;">${nomeLimpo}</div>
        <div class="comp-role" style="font-size: 0.72rem; color: var(--text-muted); font-weight: 700;">${item.Função || item["FunÃ§Ã£o"]}</div>
      </div>
    `;
      }).join('');
    }
    function fecharModalDetalhes(e) {
      if (e.target.id === 'modalPerfilComp') {
        document.getElementById('modalPerfilComp').style.display = 'none';
      }
    }
    function filtrarPorFuncao(categoria, elemento) {
      // Reset visual do filtro de genero
      document.querySelectorAll('.gender-bar-container').forEach(p => {
        p.style.opacity = '1';
        p.style.transform = 'scale(1)';
      });

      // UI: Troca a classe active no elemento clicado (agora Ã© o card)
      document.querySelectorAll('.kpi-card').forEach(p => p.classList.remove('active-filter'));
      if (elemento) elemento.classList.add('active-filter');

      // LÃ³gica: Filtra a lista original
      if (categoria === 'TODOS') {
        renderizar(dadosMembros);
      } else {
        const filtrados = dadosMembros.filter(m => {
          const f = (m["Função"] || m["FunÃ§Ã£o"] || "").toUpperCase();
          return f.includes(categoria);
        });
        renderizar(filtrados);
      }
    }

    function filtrarPorGenero(genero, elemento) {
      // Reset visual dos KPIs
      document.querySelectorAll('.kpi-card').forEach(p => p.classList.remove('active-filter'));

      // UI: Feedback visual na barra clicada
      document.querySelectorAll('.gender-bar-container').forEach(p => {
        p.style.opacity = '0.4';
        p.style.transform = 'scale(0.98)';
      });
      if (elemento) {
        elemento.style.opacity = '1';
        elemento.style.transform = 'scale(1.02)';
      }

      const filtrados = dadosMembros.filter(m => {
        const g = (m.Genero || m["GÃªnero"] || "").toString().toUpperCase().trim();
        if (genero === 'MASC') return g.includes("HOMEM") || g.includes("MASC");
        return g.includes("MULHER") || g.includes("FEM");
      });
      renderizar(filtrados);
    }
    async function buscarAvisosGeraisNoModal(nome) {
      const container = document.getElementById('modalAvisosGeraisContainer');
      const box = document.getElementById('modalAvisosGerais');
      const userToken = JSON.parse(localStorage.getItem('user_token') || '{}');
      const isAdmin = userToken.Role === "Admin" || userToken.Role === "Lider";

      if (!isAdmin) {
        container.style.display = 'none';
        return;
      }

      box.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc;">Carregando...</div>';

      try {
        const cached = localStorage.getItem('offline_lembretes');
        const lembretes = cached ? JSON.parse(cached) : [];

        const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        const nomeNormalizado = normalize(nome);

        const avisos = lembretes.filter(l =>
          l.Culto === "AVISO_LIDER" &&
          (normalize(l.Componente).includes(nomeNormalizado) || nomeNormalizado.includes(normalize(l.Componente)))
        );

        if (avisos.length > 0) {
          container.style.display = 'block';
          box.innerHTML = avisos.map(a => `
            <div style="background:#fffafa; border-left:3px solid #e67e22; padding:8px; border-radius:5px; margin-top:8px; font-size:0.8rem; position:relative;">
            <div style="font-weight:bold; margin-bottom:3px; display:flex; justify-content:space-between;">
              <span>${a.Componente}</span>
              <span style="font-size:0.7rem; color:#95a5a6;">${new Date(a.Data).toLocaleDateString('pt-BR')}</span>
            </div>
            <div style="color:#555;">${a.Info}</div>
            <i class="fas fa-trash-alt" onclick="excluirAviso('${a.id_Lembrete}', event)" style="position:absolute; right:8px; bottom:8px; color:#ddd; cursor:pointer; font-size:0.75rem;" title="Remover"></i>
            </div>
        `).join('');
        } else {
          container.style.display = 'none';
        }
      } catch (e) { console.log(e); }
    }

    async function excluirAviso(id, event) {
      if (event) event.stopPropagation();
      if (!confirm("Deseja realmente excluir este aviso?")) return;

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: "delete", sheet: "Lembretes", id_Lembrete: id })
        });
        const res = await response.json();
        if (res.status === "success") {
          alert("Aviso excluído!");
          // Atualiza localmente
          let lembretes = JSON.parse(localStorage.getItem('offline_lembretes') || '[]');
          lembretes = lembretes.filter(l => l.id_Lembrete !== id);
          localStorage.setItem('offline_lembretes', JSON.stringify(lembretes));

          // Recarrega se o modal ainda estiver aberto
          const modal = document.getElementById('modalPerfilComp');
          if (modal.style.display === 'flex') {
            // Aqui precisaria do nome, mas vamos apenas sumir com o item do DOM pra ser mais rÃ¡pido
            const el = event.target.closest('div');
            if (el) el.remove();
          }
        } else {
          alert("Erro ao excluir: " + res.message);
        }
      } catch (e) { alert("Erro de conexão."); }
    }

    function abrirFotoExpandida(url, event) {
      if (event) event.stopPropagation();
      const lb = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      img.src = url;
      lb.style.display = 'flex';
    }

    function fecharLightbox() {
      document.getElementById('lightbox').style.display = 'none';
    }

    // No local theme scripts needed, uses temas-core.js
    function aplicarPreview(id) {
      const tema = TEMAS_DISPONIVEIS[id];
      const root = document.documentElement;
      root.style.setProperty('--primary', tema.primary);
      root.style.setProperty('--secondary', tema.secondary || tema.primary);
      root.style.setProperty('--bg', tema.bg);
      root.style.setProperty('--card-bg', tema.cardBg || '#ffffff');
      root.style.setProperty('--header-bg', tema.headerBg || '#ffffff');
      root.style.setProperty('--text-primary', tema.text || '#1e293b');
      root.style.setProperty('--header-text', tema.headerText || tema.text || '#1e293b');
    }

    function confirmarTema() {
      localStorage.setItem('tema_escolhido_id', tempThemeId);
      toggleThemePanel();
      if (window.aplicarTemaAtual) aplicarTemaAtual();
    }

    window.onload = () => iniciar();
  </script>

  <div id="lightbox" class="lightbox" onclick="fecharLightbox()">
    <img id="lightboxImg" src="">
  </div>

  <div id="modalPerfilComp" class="modal-perfil" onclick="fecharModalDetalhesExterno(event)">
    <div class="modal-content-perfil" onclick="event.stopPropagation()">
      <span class="close-perfil"
        onclick="document.getElementById('modalPerfilComp').style.display='none'">&times;</span>

      <div class="modal-header">
        <div id="detalheCabecalho">
        </div>
      </div>

      <div style="text-align: left;">
        <small style="color: #e67e22; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
          <i class="fas fa-calendar-alt"></i> Próximas Escalas
        </small>
        <div id="modalEscalas" style="margin-bottom: 20px;"></div>

        <div id="modalHistoricoContainer" style="display:none; margin-bottom: 20px;">
          <small style="color: #9b59b6; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
            <i class="fas fa-music"></i> Histórico (Voz)
          </small>
          <div id="modalHistorico"></div>
        </div>

        <div id="modalAvisosGeraisContainer" style="display:none; margin-top:20px;">
          <small style="color: #e67e22; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
            <i class="fas fa-bullhorn"></i> Avisos Gerais
          </small>
          <div id="modalAvisosGerais"></div>
        </div>
      </div>

      <div id="modalAcoes" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;"></div>
    </div>
  </div>


  </div>
</body>

</html>