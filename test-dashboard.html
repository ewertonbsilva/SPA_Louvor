<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Dashboard</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
    <link rel="stylesheet" href="Shared/CSS/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div style="padding: 20px;">
        <h1>Teste Dashboard Avançado</h1>
        <button onclick="testarDashboard()" class="btn btn-primary">Testar Dashboard</button>
        <button onclick="verificarDados()" class="btn btn-secondary">Verificar Dados</button>
        <button onclick="limparDados()" class="btn btn-danger">Limpar Dados</button>
        <hr>
        <div id="dashboardContainer"></div>
        <hr>
        <div id="debugInfo"></div>
    </div>

    <!-- Scripts -->
    <script src="Shared/JS/config.js"></script>
    <script src="Shared/JS/indexeddb-manager.js"></script>
    <script src="Shared/JS/advanced-dashboard.js"></script>
    <script src="Shared/JS/shared-forms.js"></script>
    <script src="Shared/JS/temas-lista.js"></script>
    <script src="Shared/JS/temas-core.js"></script>
    
    <script>
        // Dados de teste para escalas
        const dadosTesteEscalas = [
            { Nome: "João Silva", Função: "Vocalista", Data: "2024-01-15", Cultos: "Culto Principal" },
            { Nome: "Maria Santos", Função: "Instrumentista", Data: "2024-01-15", Cultos: "Culto Principal" },
            { Nome: "Pedro Costa", Função: "Líder", Data: "2024-01-22", Cultos: "Culto Principal" },
            { Nome: "Ana Oliveira", Função: "Vocalista", Data: "2024-01-22", Cultos: "Culto Principal" },
            { Nome: "Carlos Silva", Função: "Técnico", Data: "2024-01-29", Cultos: "Culto Principal" },
            { Nome: "João Silva", Função: "Vocalista", Data: "2024-02-05", Cultos: "Culto Principal" },
            { Nome: "Maria Santos", Função: "Instrumentista", Data: "2024-02-05", Cultos: "Culto Principal" },
            { Nome: "Pedro Costa", Função: "Líder", Data: "2024-02-12", Cultos: "Culto Principal" },
            { Nome: "Ana Oliveira", Função: "Vocalista", Data: "2024-02-12", Cultos: "Culto Principal" },
            { Nome: "Carlos Silva", Função: "Técnico", Data: "2024-02-19", Cultos: "Culto Principal" }
        ];

        // Dados de teste para componentes
        const dadosTesteComponentes = [
            { Nome: "João Silva", Perfil: "Vocalista" },
            { Nome: "Maria Santos", Perfil: "Instrumentista" },
            { Nome: "Pedro Costa", Perfil: "Líder" },
            { Nome: "Ana Oliveira", Perfil: "Vocalista" },
            { Nome: "Carlos Silva", Perfil: "Técnico" },
            { Nome: "Lucia Ferreira", Perfil: "Vocalista" },
            { Nome: "Roberto Dias", Perfil: "Instrumentista" },
            { Nome: "Julia Santos", Perfil: "Vocalista" }
        ];

        function verificarDados() {
            const debugDiv = document.getElementById('debugInfo');
            const escalasLS = localStorage.getItem('offline_escala');
            const componentesLS = localStorage.getItem('offline_componentes');
            
            let html = '<h3>Status dos Dados</h3>';
            html += '<h4>localStorage:</h4>';
            html += `<p><strong>offline_escala:</strong> ${escalasLS ? 'EXISTS' : 'NOT FOUND'}</p>`;
            html += `<p><strong>offline_componentes:</strong> ${componentesLS ? 'EXISTS' : 'NOT FOUND'}</p>`;
            
            if (escalasLS) {
                try {
                    const parsed = JSON.parse(escalasLS);
                    html += `<p><strong>Escalas (localStorage):</strong> ${Array.isArray(parsed) ? parsed.length : 'NOT ARRAY'} itens</p>`;
                } catch (e) {
                    html += `<p><strong>Escalas (localStorage):</strong> INVALID JSON</p>`;
                }
            }
            
            if (componentesLS) {
                try {
                    const parsed = JSON.parse(componentesLS);
                    html += `<p><strong>Componentes (localStorage):</strong> ${Array.isArray(parsed) ? parsed.length : 'NOT ARRAY'} itens</p>`;
                } catch (e) {
                    html += `<p><strong>Componentes (localStorage):</strong> INVALID JSON</p>`;
                }
            }
            
            html += '<h4>IndexedDB:</h4>';
            
            // Verificar IndexedDB
            if (window.IDBManager) {
                window.IDBManager.get('offline_escala').then(data => {
                    html += `<p><strong>Escalas (IndexedDB):</strong> ${data ? (Array.isArray(data) ? data.length : 'OBJECT') : 'NOT FOUND'}</p>`;
                    debugDiv.innerHTML = html;
                });
                
                window.IDBManager.get('offline_componentes').then(data => {
                    html += `<p><strong>Componentes (IndexedDB):</strong> ${data ? (Array.isArray(data) ? data.length : 'OBJECT') : 'NOT FOUND'}</p>`;
                    debugDiv.innerHTML = html;
                });
            } else {
                html += '<p><strong>IndexedDB:</strong> NOT AVAILABLE</p>';
                debugDiv.innerHTML = html;
            }
            
            debugDiv.innerHTML = html;
        }

        function limparDados() {
            localStorage.removeItem('offline_escala');
            localStorage.removeItem('offline_componentes');
            
            if (window.IDBManager) {
                window.IDBManager.remove('offline_escala');
                window.IDBManager.remove('offline_componentes');
            }
            
            alert('Dados limpos com sucesso!');
            verificarDados();
        }

        function carregarDadosTeste() {
            localStorage.setItem('offline_escala', JSON.stringify(dadosTesteEscalas));
            localStorage.setItem('offline_componentes', JSON.stringify(dadosTesteComponentes));
            
            if (window.IDBManager) {
                window.IDBManager.set('offline_escala', dadosTesteEscalas);
                window.IDBManager.set('offline_componentes', dadosTesteComponentes);
            }
            
            console.log('Dados de teste carregados:', {
                escalas: dadosTesteEscalas.length,
                componentes: dadosTesteComponentes.length
            });
        }

        async function testarDashboard() {
            const container = document.getElementById('dashboardContainer');
            
            // Verificar se há dados, se não, carregar dados de teste
            const escalasLS = localStorage.getItem('offline_escala');
            const componentesLS = localStorage.getItem('offline_componentes');
            
            if (!escalasLS || !componentesLS) {
                console.log('Carregando dados de teste...');
                carregarDadosTeste();
            }
            
            // Esperar um pouco para garantir que os dados estejam disponíveis
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Renderizar dashboard
            if (window.AdvancedDashboard) {
                try {
                    await window.AdvancedDashboard.renderDashboard(container);
                    console.log('Dashboard renderizado com sucesso!');
                } catch (error) {
                    console.error('Erro ao renderizar dashboard:', error);
                    container.innerHTML = `<div class="alert alert-danger">Erro ao renderizar dashboard: ${error.message}</div>`;
                }
            } else {
                container.innerHTML = '<div class="alert alert-warning">Dashboard não disponível</div>';
            }
        }

        // Verificar dados ao carregar a página
        window.addEventListener('load', () => {
            setTimeout(verificarDados, 1000);
        });
    </script>
</body>
</html>
