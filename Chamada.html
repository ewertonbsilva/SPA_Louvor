<!DOCTYPE html>
<html lang="pt-br">

<head>
    <script src="temas-lista.js"></script>
    <script src="temas-core.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamada | Premium</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #1e293b;
            --primary-light: #334155;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-gold: #f59e0b;
            --bg-page: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-main: 16px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-top: 80px;
            overflow-x: hidden;
        }

        /* Premium Header */
        .header-bar {
            background: var(--glass);
            backdrop-filter: blur(12px);
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header-left-nav,
        .header-right-nav {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .header-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
            margin: 0;
            color: var(--primary);
            flex-grow: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-btn {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            text-decoration: none;
            font-size: 1.2rem;
        }

        .nav-btn:active {
            transform: scale(0.9);
        }

        /* THEME PANEL */
        .theme-panel {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 24px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            max-width: 240px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideIn 0.3s ease-out;
        }

        .theme-panel h3 {
            margin-top: 0;
            font-weight: 800;
            font-size: 1rem;
            color: #000 !important;
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .theme-btn-circ {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.3s;
        }

        .theme-btn-circ.active {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
        }

        .apply-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: #2c3e50;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }

        @keyframes slideIn {
            from {
                transform: translateX(50px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .container {
            max-width: 500px;
            padding: 15px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-add-main {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-main);
            padding: 16px;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 20px -5px rgba(30, 41, 59, 0.3);
            transition: 0.3s;
            margin-bottom: 25px;
        }

        .btn-add-main:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        .event-card {
            background: white;
            border-radius: var(--radius-main);
            padding: 18px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: 0.3s;
        }

        .event-card:active {
            transform: scale(0.98);
            background: #f8fafc;
        }

        .event-info-box {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            cursor: pointer;
        }

        .event-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--primary);
            margin-bottom: 2px;
        }

        .event-subtitle {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-action-icon {
            color: #cbd5e1;
            padding: 8px;
            transition: 0.2s;
            cursor: pointer;
        }

        .btn-action-icon:hover {
            color: var(--accent-red);
        }

        .view-header {
            text-align: center;
            padding: 10px 0 25px;
        }

        .view-header h4 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0;
            color: var(--primary);
        }

        .view-header p {
            font-weight: 600;
            color: var(--text-muted);
            margin-top: 4px;
            font-size: 0.95rem;
        }

        .summary-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .pill {
            padding: 6px 14px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-sm);
        }

        .pill-green {
            background: #d1fae5;
            color: #065f46;
        }

        .pill-red {
            background: #fee2e2;
            color: #991b1b;
        }

        .pill-gold {
            background: #fef3c7;
            color: #92400e;
        }

        .member-card {
            background: white;
            border-radius: var(--radius-main);
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            border-left: 6px solid #e2e8f0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .member-card.state-P {
            border-left-color: var(--accent-green);
            background: #f0fdf4;
        }

        .member-card.state-A {
            border-left-color: var(--accent-red);
            background: #fef2f2;
        }

        .member-card.state-J {
            border-left-color: var(--accent-gold);
            background: #fffbeb;
        }

        .member-avatar {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .member-name {
            font-weight: 600;
            font-size: 0.95rem;
            flex-grow: 1;
            color: var(--primary);
        }

        .action-group {
            display: flex;
            gap: 6px;
        }

        .btn-status {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: 1px solid #f1f5f9;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            transition: 0.2s;
            font-size: 0.8rem;
        }

        .btn-status.active.p {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
        }

        .btn-status.active.a {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2);
        }

        .btn-status.active.j {
            background: var(--accent-gold);
            color: white;
            border-color: var(--accent-gold);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.2);
        }

        .btn-status.btn-remove {
            border: none;
            background: transparent;
            color: #cbd5e1;
        }

        .btn-status.btn-remove:hover {
            color: var(--accent-red);
        }

        /* Modals FIXED & CENTERED */
        .modal {
            display: none;
            /* Inicia oculto */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            border: none;
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 340px;
            background: white;
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            display: block;
        }

        .premium-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 14px;
            font-family: inherit;
            margin-bottom: 20px;
            transition: 0.3s;
            width: 100%;
            box-sizing: border-box;
        }

        .premium-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 41, 59, 0.1);
            outline: none;
        }

        .btn-modal-action {
            padding: 14px;
            border-radius: 14px;
            font-weight: 700;
            border: none;
            flex: 1;
            transition: 0.2s;
        }
    </style>
</head>

<body style="padding-top: 80px;">

    <div class="header-bar">
        <div class="header-left-nav">
            <i class="fas fa-arrow-left nav-btn" id="btnBack" title="Voltar"></i>
            <i class="fas fa-home nav-btn" onclick="window.location.href='index.html'" title="Início"></i>
        </div>
        <h2 class="header-title" id="pageTitle">Chamada</h2>
        <div class="header-right-nav">
            <i class="fas fa-palette nav-btn" onclick="toggleThemePanel()" title="Trocar Tema"></i>
            <i class="fas fa-sync-alt nav-btn" onclick="fetchEvents()" title="Sincronizar"></i>
        </div>
    </div>

    <div id="themePanel" class="theme-panel">
        <h3>Escolha um Tema</h3>
        <div class="theme-buttons" id="themeButtonsGrid"></div>
        <button class="apply-btn" onclick="confirmarTema()">USAR ESTE TEMA</button>
    </div>

    <div class="container">
        <!-- View: Event List -->
        <div id="viewEvents">
            <button class="btn-add-main" onclick="openCreateModal()">
                <i class="fas fa-plus"></i> Novo Evento
            </button>
            <div id="eventsList">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>

        <!-- View: Attendance View -->
        <div id="viewAttendance" style="display: none;">
            <div class="view-header">
                <h4 id="displayTheme">Tema</h4>
                <p id="displayDate">00/00/0000</p>
            </div>

            <div class="summary-container">
                <div class="pill pill-green"><i class="fas fa-check"></i> <span id="countPresent">0</span></div>
                <div class="pill pill-red"><i class="fas fa-times"></i> <span id="countAbsent">0</span></div>
                <div class="pill pill-gold"><i class="fas fa-file-alt"></i> <span id="countJustified">0</span></div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4 px-1">
                <span
                    style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase;">Membros
                    Consagrados</span>
                <button class="btn btn-sm btn-white border-0" onclick="openAddInactiveModal()"
                    style="font-weight: 700; color: var(--primary); font-size: 0.75rem;">
                    <i class="fas fa-plus-circle me-1"></i> ADD MEMBRO
                </button>
            </div>

            <div class="attendance-list" id="compList"></div>

            <button class="btn-add-main mt-5" id="btnSaveAttendance">
                <i class="fas fa-cloud-upload-alt"></i> Finalizar Chamada
            </button>
        </div>
    </div>

    <!-- MODAL: ADD EVENT -->
    <div id="modalEvent" class="modal">
        <div class="modal-content">
            <div style="width: 40px; height: 5px; background: #e2e8f0; border-radius: 10px; margin: 0 auto 20px;"></div>
            <h5 class="header-title mb-4 text-center" style="font-size: 1.3rem;">Cadastrar Nova Aula</h5>
            <label class="modal-label">TEMA DA AULA</label>
            <input type="text" id="eventTheme" class="premium-input" placeholder="Ex: 1ª Aula - Santificação">
            <label class="modal-label">DATA DE REALIZAÇÃO</label>
            <input type="date" id="eventDate" class="premium-input">
            <div class="d-flex gap-3">
                <button class="btn-modal-action" style="background: #f1f5f9; color: var(--text-muted);"
                    onclick="closeModal('modalEvent')">Cancelar</button>
                <button class="btn-modal-action" style="background: var(--primary); color: white;"
                    onclick="saveNewEvent()">Criar Aula</button>
            </div>
        </div>
    </div>

    <!-- MODAL: JUSTIFY -->
    <div id="modalJustify" class="modal">
        <div class="modal-content">
            <h5 class="header-title mb-1">Justificativa</h5>
            <p id="justifyWorkerName"
                style="color: var(--text-muted); font-weight: 600; font-size: 0.9rem; margin-bottom: 20px;"></p>
            <textarea id="justifyText" class="premium-input" rows="4"
                placeholder="Descreva brevemente o motivo da ausência..."></textarea>
            <div class="d-flex gap-3">
                <button class="btn-modal-action" style="background: #f1f5f9; color: var(--text-muted);"
                    onclick="closeModal('modalJustify')">Voltar</button>
                <button class="btn-modal-action" style="background: var(--accent-gold); color: white;"
                    onclick="confirmJustify()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD MEMBER (RESTORED) -->
    <div id="modalAddInactive" class="modal">
        <div class="modal-content">
            <h5 class="header-title mb-3">Adicionar Membro</h5>
            <label class="modal-label">SELECIONE O MEMBRO</label>
            <select id="selectInactive" class="premium-input"></select>
            <div class="d-flex gap-3">
                <button class="btn-modal-action" style="background: #f1f5f9; color: var(--text-muted);"
                    onclick="closeModal('modalAddInactive')">Fechar</button>
                <button class="btn-modal-action" style="background: var(--primary); color: white;"
                    onclick="addInactiveToAttendance()">Adicionar</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="sync.js"></script>
    <script>
        let allEvents = [];
        let allComponents = [];
        let currentEvent = null;
        let attendanceData = {};
        let currentCompJustifying = null;

        document.getElementById('btnBack').addEventListener('click', () => {
            const viewAttendance = document.getElementById('viewAttendance');
            if (viewAttendance && (viewAttendance.style.display === 'flex' || viewAttendance.style.display === 'block')) {
                showView('events');
                fetchData(true); // silent refresh
            } else {
                window.location.href = 'MenuUtilitarios.html';
            }
        });

        // --- TEMA ---
        // No local theme scripts needed, uses temas-core.js

        async function init() {
            await fetchData();
            // SÃ³ muda para 'events' se nÃ£o houver aula aberta (ex: primeiro load)
            if (!currentEvent) showView('events');
        }

        async function fetchData(silent = false) {
            try {
                // Eventos do Cache
                const cachedEvents = localStorage.getItem('offline_consagracao');
                if (cachedEvents) {
                    allEvents = JSON.parse(cachedEvents);
                    if (!silent) renderEvents();
                }

                // Busca Live
                const resEvents = await fetch(`${APP_CONFIG.SCRIPT_URL}?sheet=Consagração`);
                const dataEvents = await resEvents.json();
                allEvents = dataEvents.data || [];
                localStorage.setItem('offline_consagracao', JSON.stringify(allEvents));
                renderEvents();

                // Componentes
                const cachedComp = localStorage.getItem('offline_componentes');
                let components = cachedComp ? JSON.parse(cachedComp) : [];
                if (!cachedComp) {
                    const r = await fetch(`${APP_CONFIG.SCRIPT_URL}?sheet=Componentes`);
                    const d = await r.json();
                    components = d.data;
                    localStorage.setItem('offline_componentes', JSON.stringify(components));
                }

                allComponents = components.filter(c => {
                    const nome = (c.Nome || "").toUpperCase().trim();
                    const func = (c.Função || "").toUpperCase().trim();
                    return nome !== "CONVIDADO" && func !== "CONVIDADO";
                });

                // Cache PresenÃ§as
                fetch(`${APP_CONFIG.SCRIPT_URL}?sheet=Comp_Cons`)
                    .then(res => res.json())
                    .then(json => localStorage.setItem('offline_chamada', JSON.stringify(json.data || [])))
                    .catch(e => console.warn("Cache background fail", e));

            } catch (e) {
                console.error("Fetch Error:", e);
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsList');
            if (allEvents.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">Nenhuma aula cadastrada.</div>';
                return;
            }
            const sorted = [...allEvents].sort((a, b) => new Date(b.DATA || b.Data) - new Date(a.DATA || a.Data));

            container.innerHTML = sorted.map(ev => `
                <div class="event-card">
                    <div class="event-info-box" onclick="openAttendance('${ev.ID_AULA || ev.ID}')">
                        <span class="event-title">${ev.TEMA || ev.Tema}</span>
                        <span class="event-subtitle">
                            <i class="far fa-calendar-alt"></i> ${formatDate(ev.DATA || ev.Data)}
                        </span>
                    </div>
                    <div class="btn-action-icon" onclick="deleteEvent('${ev.ID_AULA || ev.ID}', '${ev.TEMA || ev.Tema}')">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                </div>
            `).join('');
        }

        async function deleteEvent(id, theme) {
            if (!confirm(`Excluir permanentemente a aula "${theme}"?`)) return;
            SyncManager.addToQueue({ action: "deleteEvent", ID_AULA: id });
            allEvents = allEvents.filter(e => (e.ID_AULA || e.ID) !== id);
            localStorage.setItem('offline_consagracao', JSON.stringify(allEvents));
            renderEvents();
        }

        async function openAttendance(id) {
            currentEvent = allEvents.find(e => (e.ID_AULA || e.ID) === id);
            if (!currentEvent) return;

            document.getElementById('displayTheme').innerText = currentEvent.TEMA || currentEvent.Tema;
            document.getElementById('displayDate').innerText = formatDate(currentEvent.DATA || currentEvent.Data);

            attendanceData = {};
            const cachedPres = localStorage.getItem('offline_chamada');
            let existing = cachedPres ? JSON.parse(cachedPres).filter(c => c.ID_AULA === id) : [];

            if (existing.length > 0) {
                existing.forEach(c => {
                    attendanceData[c.NOME] = { status: c.PRESENÇA || 'AUSENTE', text: (c.COMPONENTES || c.Justificativa) || '' };
                });
            } else {
                allComponents.filter(c => String(c.Ativo).toUpperCase().trim() === "SIM")
                    .forEach(c => attendanceData[c.Nome] = { status: 'AUSENTE', text: '' });
            }

            renderComponents();
            showView('attendance');
            window.scrollTo(0, 0);
        }

        function renderComponents() {
            const container = document.getElementById('compList');
            const cachedImg = localStorage.getItem('offline_imagens');
            const dbImg = cachedImg ? JSON.parse(cachedImg) : [];
            const names = Object.keys(attendanceData).sort();
            let p = 0, a = 0, j = 0;

            container.innerHTML = names.map(name => {
                const comp = allComponents.find(c => c.Nome === name) || { Nome: name };
                const fotoPath = dbImg.find(img => img.nome === (comp.Foto || "").split('/').pop());
                const imgUrl = fotoPath ? fotoPath.url : "https://ui-avatars.com/api/?name=" + name + "&background=random";
                const status = attendanceData[name].status;
                if (status === 'PRESENTE') p++; else if (status === 'JUSTIFICADO') j++; else a++;

                return `
                    <div class="member-card state-${status[0]}">
                        <img src="${imgUrl}" class="member-avatar">
                        <span class="member-name">${name}</span>
                        <div class="action-group">
                            <button class="btn-status p ${status === 'PRESENTE' ? 'active' : ''}" onclick="setStatus('${name}', 'PRESENTE')"><i class="fas fa-check"></i></button>
                            <button class="btn-status a ${status === 'AUSENTE' ? 'active' : ''}" onclick="setStatus('${name}', 'AUSENTE')"><i class="fas fa-times"></i></button>
                            <button class="btn-status j ${status === 'JUSTIFICADO' ? 'active' : ''}" onclick="openJustifyModal('${name}')"><i class="fas fa-file-alt"></i></button>
                            <button class="btn-status btn-remove" onclick="removeMember('${name}')"><i class="fas fa-user-minus"></i></button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('countPresent').innerText = p;
            document.getElementById('countAbsent').innerText = a;
            document.getElementById('countJustified').innerText = j;
        }

        function setStatus(name, status) {
            attendanceData[name].status = status;
            if (status !== 'JUSTIFICADO') attendanceData[name].text = '';
            renderComponents();
        }

        function removeMember(name) {
            if (confirm(`Remover "${name}" desta aula?`)) {
                delete attendanceData[name];
                renderComponents();
            }
        }

        function openJustifyModal(name) {
            currentCompJustifying = name;
            document.getElementById('justifyWorkerName').innerText = name;
            document.getElementById('justifyText').value = attendanceData[name]?.text || '';
            openModal('modalJustify');
        }

        function confirmJustify() {
            const val = document.getElementById('justifyText').value.trim();
            if (!val) return alert("Insira o motivo.");
            attendanceData[currentCompJustifying] = { status: 'JUSTIFICADO', text: val };
            closeModal('modalJustify');
            renderComponents();
        }

        function openAddInactiveModal() {
            const select = document.getElementById('selectInactive');
            const currentNames = Object.keys(attendanceData);
            const candidates = allComponents.filter(c => !currentNames.includes(c.Nome)).sort((a, b) => a.Nome.localeCompare(b.Nome));

            if (candidates.length === 0) return alert("Todos os membros já estão na lista.");
            select.innerHTML = candidates.map(c => `<option value="${c.Nome}">${c.Nome}</option>`).join('');
            openModal('modalAddInactive');
        }

        function addInactiveToAttendance() {
            const name = document.getElementById('selectInactive').value;
            if (name) {
                attendanceData[name] = { status: 'AUSENTE', text: '' };
                renderComponents();
                closeModal('modalAddInactive');
            }
        }

        async function saveNewEvent() {
            const date = document.getElementById('eventDate').value;
            const theme = document.getElementById('eventTheme').value.trim();
            if (!date || !theme) return alert("Preencha todos os campos.");
            const id = Math.random().toString(16).substring(2, 10);
            const ev = { DATA: date, TEMA: theme, ID_AULA: id, STATUS: "FECHADO" };
            SyncManager.addToQueue({ action: "addRow", sheet: "Consagração", data: ev });
            allEvents.unshift(ev);
            localStorage.setItem('offline_consagracao', JSON.stringify(allEvents));
            renderEvents();
            closeModal('modalEvent');
        }

        document.getElementById('btnSaveAttendance').addEventListener('click', () => {
            const names = Object.keys(attendanceData);
            if (names.length === 0) return alert("Lista vazia.");
            const batch = names.map(n => ({
                "COMPONENTES": attendanceData[n].text || "",
                "NOME": n,
                "PRESENÇA": attendanceData[n].status,
                "ID_AULA": currentEvent.ID_AULA || currentEvent.ID
            }));
            SyncManager.addToQueue({ action: "saveAttendance", ID_AULA: currentEvent.ID_AULA || currentEvent.ID, data: batch });
            const cache = JSON.parse(localStorage.getItem('offline_chamada') || '[]');
            const cleaned = cache.filter(c => c.ID_AULA !== (currentEvent.ID_AULA || currentEvent.ID));
            localStorage.setItem('offline_chamada', JSON.stringify([...cleaned, ...batch]));
            alert("Sincronizando chamada...");
            showView('events');
        });

        function showView(v) {
            document.getElementById('viewEvents').style.display = v === 'events' ? 'block' : 'none';
            document.getElementById('viewAttendance').style.display = v === 'attendance' ? 'block' : 'none';
            document.getElementById('pageTitle').innerText = v === 'events' ? 'Chamada Consagração' : 'Realizar Chamada';
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openCreateModal() {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('eventTheme').value = '';
            openModal('modalEvent');
        }
        function formatDate(s) { if (!s) return ""; return new Date(s).toLocaleDateString('pt-BR'); }
        window.onclick = e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };
        init();
    </script>
</body>

</html>