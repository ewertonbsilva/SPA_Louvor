<!DOCTYPE html>
<html lang="pt-br">

<head>
  <script src="temas-lista.js"></script>
  <script src="temas-core.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escala e Repertório</title>
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <script src="sync.js"></script>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <style>
    body {
      padding-top: 80px;
      padding-bottom: 100px;
      /* Prevent bottom cutoff */
    }

    :root {
      --primary: #2c3e50;
      --accent: #3498db;
      --bg: #f4f7f6;
      --music-bg: #fdf2e9;
      --music-text: #e67e22;
      --danger: #e74c3c;
      --success: #27ae60;
      /* Cores dos Ã­cones */
      --yt: #ff0000;
      --sp: #1db954;
      --cf: #f1c40f;
      --lt: #3498db;
    }

    /* Estilo comum para todos os Ã­cones da lista */
    .member-item i {
      font-size: 1.2rem;
      filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.2));
    }

    /* Cores especÃ­ficas baseadas na categoria */
    .member-item i.Violão {
      color: #e67e22;
    }

    /* Laranja */
    .member-item i.Guitarra {
      color: #e74c3c;
    }

    /* Vermelho/Coral */
    .member-item i.Baixo {
      color: #9b59b6;
    }

    /* Roxo */

    /* Outras cores do grÃ¡fico */
    .member-item i.Ministro {
      color: #3498db;
    }

    /* Azul */
    .member-item i.Back {
      color: #1abc9c;
    }

    /* Ciano */
    .member-item i.Teclado {
      color: #f1c40f;
    }

    /* Amarelo */
    .member-item i.Bateria {
      color: #2ecc71;
    }

    /* Verde */

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 0;
    }



    #searchInput {
      flex-grow: 1;
      display: block;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 30px;
      outline: none;
    }

    .header-bar {
      background: var(--glass);
      backdrop-filter: blur(12px);
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .header-left,
    .header-right {
      display: flex;
      gap: 0px;
      align-items: center;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      flex-grow: 1;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-btn {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      cursor: pointer;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      font-size: 1.2rem;
      padding: 10px;
    }

    .nav-btn:active {
      transform: scale(0.9);
    }

    /* THEME PANEL */
    .theme-panel {
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 24px;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      z-index: 10001;
      max-width: 240px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.05);
      animation: slideIn 0.3s ease-out;
    }

    .theme-panel h3 {
      margin-top: 0;
      font-weight: 800;
      font-size: 1rem;
      color: #000 !important;
    }

    .theme-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .theme-btn-circ {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: 0.3s;
    }

    .theme-btn-circ.active {
      border-color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
    }

    .apply-btn {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }

    @keyframes slideIn {
      from {
        transform: translateX(50px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .accordion-item {
      background: white;
      margin-bottom: 15px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.02);
      border-left: 6px solid var(--primary);
    }

    .accordion-header {
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-info h3 {
      margin: 0;
      font-size: 1.2rem;
      /* Increased */
      color: var(--primary);
    }

    .header-info span {
      font-size: 0.95rem;
      /* Increased */
      color: #7f8c8d;
    }

    /* Estilo do botÃ£o Add All integrado */
    .btn-add-bulk {
      background: var(--success);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.7rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: 0.3s;
      margin-left: 10px;
    }

    .btn-add-bulk:hover {
      background: #219150;
      transform: scale(1.05);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: #fafafa;
    }

    .active .accordion-content {
      max-height: 2000px;
    }

    .active .icon-arrow {
      transform: rotate(180deg);
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
      border-top: 1px solid #eee;
    }

    .section-title-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
      color: #95a5a6;
    }

    .member-item {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #f1f1f1;
      font-size: 0.9rem;
    }

    .member-item i {
      width: 25px;
      color: var(--accent);
    }

    .member-info {
      display: flex;
      justify-content: space-between;
      flex-grow: 1;
    }

    .m-funcao {
      font-size: 0.7rem;
      color: #999;
    }

    .btn-ausencia {
      background: #fdf2f2;
      color: #e74c3c;
      border: 1px solid #fadbd8;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      cursor: pointer;
      margin-left: 10px;
      transition: 0.2s;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .btn-ausencia:hover {
      background: #e74c3c;
      color: white;
    }

    .musica-item {
      background: var(--music-bg);
      color: #5d4037;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      border-left: 4px solid var(--music-text);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .m-nome-musica {
      font-weight: 600;
      color: #2d3436;
      padding-right: 30px;
      margin-bottom: 4px;
    }

    .m-cantor {
      font-size: 0.8rem;
      color: #d35400;
      font-style: italic;
    }

    .m-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }

    .m-tom {
      font-weight: bold;
      color: #2c3e50;
      font-size: 0.75rem;
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #eee;
    }

    .m-links {
      display: flex;
      gap: 10px;
      font-size: 1rem;
    }

    .m-links a {
      text-decoration: none;
      transition: 0.2s;
    }

    .m-links a:hover {
      transform: scale(1.2);
    }

    .l-yt {
      color: var(--yt);
    }

    .l-cf {
      color: var(--cf);
      filter: drop-shadow(0 0 1px #000);
    }

    .l-sp {
      color: var(--sp);
    }

    .l-lt {
      color: var(--lt);
    }

    .btn-del-musica {
      position: absolute;
      right: 8px;
      top: 8px;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.3s;
    }

    .btn-del-musica:hover {
      color: var(--danger);
    }

    .icon-arrow {
      transition: transform 0.3s;
    }

    .hidden {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #888;
    }

    @media (max-width: 600px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    /* LANDSCAPE OPTIMIZATION */
    @media (min-width: 800px) {
      #escala-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        align-items: flex-start;
      }

      .container {
        max-width: 1000px;
      }
    }

    /* MODALS */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      padding: 15px;
      box-sizing: border-box;
    }

    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 24px;
      width: 95%;
      max-width: 400px;
      position: relative;
    }

    .close-modal {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
    }

    .premium-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      margin-bottom: 20px;
      background: #f8fafc;
      transition: all 0.2s;
      outline: none;
      font-family: inherit;
    }

    .btn-premium {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-premium:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>

<body style="padding-top: 80px;">

  <div class="header-bar">
    <div class="header-left">
      <i class="fas fa-arrow-left nav-btn" onclick="window.location.href='MenuEscalas.html'" title="Voltar"></i>
      <i class="fas fa-home nav-btn" onclick="window.location.href='index.html'" title="Início"></i>
    </div>
    <h2 class="header-title">Escalas</h2>
    <div class="header-right">
      <i class="fas fa-palette nav-btn" onclick="toggleThemePanel()" title="Trocar Tema"></i>
      <i class="fas fa-sync-alt nav-btn" onclick="loadAll(true)" title="Sincronizar"></i>
    </div>
  </div>

  <div id="themePanel" class="theme-panel">
    <h3>Escolha um Tema</h3>
    <div class="theme-buttons" id="themeButtonsGrid"></div>
    <button class="apply-btn" onclick="confirmarTema()">USAR ESTE TEMA</button>
  </div>

  <!-- MODAL AVISO MEMBRO -->
  <div id="modalAvisoMembro" class="modal"
    style="display:none; position:fixed; z-index:10001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); align-items:center; justify-content:center; padding:15px;">
    <div class="modal-content"
      style="background:#fff; padding:30px; border-radius:24px; width:100%; max-width:400px; position:relative;">
      <span class="close-modal" onclick="fecharModalAvisoMembro()"
        style="position:absolute; right:20px; top:20px; font-size:1.5rem; cursor:pointer;">&times;</span>
      <h3 style="margin-top:0; font-weight:800; color:var(--primary);">Comunicar Aviso</h3>
      <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">
        Culto: <b id="displayCultoAviso" style="color:var(--primary);">--</b>
      </p>
      <input type="hidden" id="inputCultoAviso">
      <textarea id="textoAvisoMembro" class="premium-input" placeholder="Ex: Não poderei ir por motivo de saúde..."
        rows="4"
        style="width:100%; margin-bottom:15px; border-radius:12px; border:1px solid #e2e8f0; padding:12px; font-family:inherit;"></textarea>
      <button id="btnEnviarAvisoMembro" class="btn-premium" onclick="enviarAvisoMembro()"
        style="width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">ENVIAR
        AVISO</button>
    </div>
  </div>

  <style>
    .premium-input:focus {
      border-color: var(--accent) !important;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
  </style>

  <div class="search-container"
    style="padding: 15px; background: var(--glass); backdrop-filter: blur(8px); border-bottom: 1px solid #f1f5f9; position: fixed; top: 70px; left:0; right:0; z-index: 999;">
    <div style="max-width: 500px; margin: 0 auto;">
      <input type="text" id="searchInput" placeholder="Pesquisar..." onkeyup="filterEscala()" class="premium-input"
        style="margin-bottom: 0; box-shadow: var(--shadow-sm);">
    </div>
  </div>

  <div class="premium-container" style="max-width: 1000px; padding-top: 170px;">

    <div id="loader" class="loading" style="display:none"><i class="fas fa-sync fa-spin"></i> Carregando Escalas...
    </div>
    <div id="escala-container" class="container"></div>

    <script>
      const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;
      const urlEscala = SCRIPT_URL + "?sheet=Transformar";
      const urlRepertorio = SCRIPT_URL + "?sheet=Repertório";
      const urlLembretes = SCRIPT_URL + "?sheet=Lembretes";

      const iconsMap = {
        "Ministro": "fa-microphone-lines",
        "Back": "fa-microphone",
        "Violão": "fa-guitar",
        "Guitarra": "fa-guitar",
        "Teclado": "fa-keyboard",
        "Bateria": "fa-drum",
        "Baixo": "fa-guitar"
      };
      async function loadAll(forceUpdate = false) {
        const loader = document.getElementById('loader');
        const cachedEscala = localStorage.getItem('offline_escala');
        const cachedRepertorio = localStorage.getItem('offline_repertorio');
        const cachedLembretes = localStorage.getItem('offline_lembretes');

        if (!forceUpdate && cachedEscala && cachedRepertorio && cachedLembretes) {
          renderMaster(JSON.parse(cachedEscala), JSON.parse(cachedRepertorio), JSON.parse(cachedLembretes));
          setTimeout(() => silentSync(), 500);
          return;
        }

        loader.style.display = 'block';
        loader.innerHTML = '<i class="fas fa-sync fa-spin"></i> Atualizando dados...';

        try {
          const [resEscala, resRepertorio, resLembretes] = await Promise.all([
            fetch(urlEscala), fetch(urlRepertorio), fetch(urlLembretes)
          ]);
          const escalaJson = await resEscala.json();
          const repertorioJson = await resRepertorio.json();
          const lembretesJson = await resLembretes.json();

          localStorage.setItem('offline_escala', JSON.stringify(escalaJson.data));
          localStorage.setItem('offline_repertorio', JSON.stringify(repertorioJson.data));
          localStorage.setItem('offline_lembretes', JSON.stringify(lembretesJson.data));

          loader.style.display = 'none';
          renderMaster(escalaJson.data, repertorioJson.data, lembretesJson.data);
          if (forceUpdate) alert("Escalas atualizadas!");
        } catch (e) {
          if (cachedEscala && cachedRepertorio) renderMaster(JSON.parse(cachedEscala), JSON.parse(cachedRepertorio), JSON.parse(cachedLembretes || '[]'));
          else loader.innerText = "Erro ao carregar dados.";
        }
      }

      async function silentSync() {
        try {
          const [resEscala, resRepertorio, resLembretes] = await Promise.all([
            fetch(urlEscala), fetch(urlRepertorio), fetch(urlLembretes)
          ]);
          const escalaJson = await resEscala.json();
          const repertorioJson = await resRepertorio.json();
          const lembretesJson = await resLembretes.json();

          localStorage.setItem('offline_escala', JSON.stringify(escalaJson.data));
          localStorage.setItem('offline_repertorio', JSON.stringify(repertorioJson.data));
          localStorage.setItem('offline_lembretes', JSON.stringify(lembretesJson.data));

          // SÃ³ renderiza se nÃ£o houver busca ativa E nenhum accordion aberto
          const hasActiveItems = document.querySelector('.accordion-item.active') !== null;
          if (document.getElementById('searchInput').value === "" && !hasActiveItems) {
            renderMaster(escalaJson.data, repertorioJson.data, lembretesJson.data);
          }
        } catch (e) { console.log("Silent sync failed"); }
      }

      function renderMaster(escalas, musicas, lembretes = []) {
        const container = document.getElementById('escala-container');
        container.innerHTML = '';
        const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

        const escalaAgrupada = escalas.reduce((acc, item) => {
          const dataItem = new Date(item.Data);
          if (dataItem >= hoje) {
            const key = item.Cultos;
            if (!acc[key]) acc[key] = { info: item, membros: [] };
            acc[key].membros.push({ nome: item.Nome, funcao: item["Função"] });
          }
          return acc;
        }, {});

        const repertorioAgrupado = musicas.reduce((acc, item) => {
          const key = item["Culto+Data"];
          if (!acc[key]) acc[key] = [];
          acc[key].push(item);
          return acc;
        }, {});

        const escalasFiltradas = Object.values(escalaAgrupada).sort((a, b) => new Date(a.info.Data) - new Date(b.info.Data));

        if (escalasFiltradas.length === 0) {
          container.innerHTML = '<div class="loading">NÃ£o hÃ¡ cultos agendados.</div>';
          return;
        }

        escalasFiltradas.forEach(item => {
          const key = item.info.Cultos;
          const dataObj = new Date(item.info.Data);
          // Remove a vÃ­rgula do formato: ex "dom. 18/01"
          const dataFormatada = dataObj.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' }).replace(',', '');
          const dataAvisoCheck = dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          const dataFullFormatada = dataObj.toLocaleDateString('pt-BR');
          const musicasDoCulto = repertorioAgrupado[key] || [];

          // Filtrar lembretes deste culto especÃ­fico (Aproximado por dd/mm + Nome do Culto)
          const avisosDoCulto = lembretes.filter(l => {
            const matchData = l.Culto && l.Culto.includes(dataAvisoCheck);
            const matchNome = l.Culto && l.Culto.toLowerCase().includes(item.info["Nome dos Cultos"].toLowerCase().trim());
            return matchData && matchNome;
          });

          // Verifica se o usuÃ¡rio logado estÃ¡ escoladado neste culto
          const userToken = JSON.parse(localStorage.getItem('user_token') || '{}');
          const meuNomeLogado = (userToken.Nome || "").toLowerCase().trim();
          const isAdmin = userToken.Role === "Admin" || userToken.Role === "SuperAdmin";

          // Helper para normalizar nomes
          const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
          const nomeNormalizado = normalize(meuNomeLogado);

          const estouEscalado = (nomeNormalizado && item.membros.some(m => {
            const mNome = normalize(m.nome);
            return mNome.includes(nomeNormalizado) || nomeNormalizado.includes(mNome);
          }));

          const itemEl = document.createElement('div');
          itemEl.className = 'accordion-item';
          itemEl.setAttribute('data-search', (item.info["Nome dos Cultos"] + " " + item.membros.map(m => m.nome).join(" ")).toLowerCase());

          // Armazena as mÃºsicas para a funÃ§Ã£o Bulk
          itemEl.dataset.musicas = JSON.stringify(musicasDoCulto.map(m => ({
            musica: m.Músicas, cantor: m.Cantor, tom: m.Tons
          })));

          itemEl.innerHTML = `
        <div class="accordion-header" onclick="this.parentElement.classList.toggle('active')">
          <div class="header-info">
            <h3>${item.info["Nome dos Cultos"]}</h3>
            <span>📅 ${dataFormatada}</span>
          </div>
          <i class="fas fa-chevron-down icon-arrow"></i>
        </div>
        <div class="accordion-content">
          <div class="content-grid">
            <div>
              <div class="section-title-container">
                <span class="section-title"><i class="fas fa-users"></i> Equipe</span>
                ${estouEscalado ? `
                  <button class="btn-ausencia" onclick="comunicarAusencia('${item.info.Cultos}', event)" title="Comunicar Aviso">
                    <i class="fas fa-bell"></i> Avisos
                  </button>
                ` : ''}
              </div>
        ${item.membros.map(m => {
            const categoria = m.funcao.split(' ')[0]; // Pega "Violão", "Guitarra", etc.
            const iconeBase = iconsMap[categoria] || 'fa-star';

            return `
          <div class="member-item">
            <i class="fa-solid ${iconeBase} ${categoria}"></i>
            <div class="member-info">
                <span class="m-nome">${m.nome}</span>
                <span class="m-funcao">${m.funcao}</span>
            </div>
            </div>`;
          }).join('')}

              ${avisosDoCulto.length > 0 ? `
                <div class="extra-section" style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                  <span class="section-title" style="color:#e74c3c; font-size:0.7rem;"><i class="fas fa-exclamation-circle"></i> Avisos</span>
                  ${avisosDoCulto.map(a => `
                    <div style="font-size:0.8rem; background:#fff5f5; padding:8px; border-radius:5px; margin-top:5px; border-left:3px solid #e74c3c; position:relative;">
                      <b>${a.Componente}:</b> ${a.Info}
                      ${a.Componente.toLowerCase().trim() === meuNomeLogado ? `
                        <i class="fas fa-trash-alt" 
                           onclick="excluirAviso('${a.id_Lembrete}', event)" 
                           style="position:absolute; right:8px; top:8px; color:#e74c3c; cursor:pointer; font-size:0.7rem;"
                           title="Remover Aviso"></i>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
            <div>
              <div class="section-title-container">
                <span class="section-title"><i class="fas fa-music"></i> Repertório</span>
                ${estouEscalado ? `
                  <button class="btn-add-bulk" onclick="navigateToAddRepertorio('${item.info.Cultos}')">
                    <i class="fas fa-plus-circle"></i> Repertório
                  </button>
                ` : ''}
              </div>
              <div class="repertorio-list">
                ${musicasDoCulto.length > 0 ? `
                   ${estouEscalado ? `
                        <button class="btn-add-bulk" style="margin-bottom:10px; width:100%; background:#2ecc71;" onclick="processarBulk(this, event)">
                            <i class="fas fa-history"></i> Add Histórico
                        </button>
                   ` : ''}
                ` : ''}
                ${musicasDoCulto.length > 0 ? musicasDoCulto.map(m => {
            const queryBusca = encodeURIComponent(`${m.Músicas}`);
            const querySpotify = encodeURIComponent(`${m.Músicas} ${m.Cantor || ''}`);
            return `
                  <div class="musica-item">
                    <span class="m-nome-musica">${m.Músicas}</span>
                    <span class="m-cantor">
                      <i class="fas fa-user-voice" style="font-size: 10px;"></i> ${m.Cantor || 'Líder não definido'}
                    </span>
                    <div class="m-footer">
                      ${m.Tons ? `<span class="m-tom">${m.Tons}</span>` : '<span class="m-tom">--</span>'}
                      <div class="m-links">
                        <a href="https://www.youtube.com/results?search_query=${queryBusca}" target="_blank" class="l-yt" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://open.spotify.com/search/${querySpotify}" target="_blank" class="l-sp" title="Spotify"><i class="fab fa-spotify"></i></a>
                        <a href="https://www.cifraclub.com.br/?q=${queryBusca}" target="_blank" class="l-cf" title="Cifra Club"><i class="fas fa-guitar"></i></a>
                        <a href="https://www.letras.mus.br/?q=${queryBusca}" target="_blank" class="l-lt" title="Letras.mus"><i class="fas fa-align-left"></i></a>
                      </div>
                    </div>
                    <button class="btn-del-musica" onclick="excluirMusica('${m.Músicas.replace(/'/g, "\\'")}', '${key}', '${m.Cantor.replace(/'/g, "\\'")}')" title="Excluir">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>`;
          }).join('') : '<span style="color:#ccc; font-size:0.85rem">Aguardando repertório...</span>'}
              </div>
            </div>
          </div>
        </div>
      `;
          container.appendChild(itemEl);
        });
      }

      // --- FUNÇÕES DE HISTÓRICO BULK ---
      function processarBulk(btn, event) {
        event.stopPropagation(); // Evita que o accordion feche ao clicar no botÃ£o
        const item = btn.closest('.accordion-item');
        const musicas = item.dataset.musicas;
        addBulkHistorico(btn, musicas);
      }

      async function addBulkHistorico(btn, jsonStr) {
        if (!confirm("Adicionar todas as músicas deste culto ao histórico? (Duplicatas serão ignoradas)")) return;

        const lista = JSON.parse(jsonStr);
        const originalContent = btn.innerHTML;

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        btn.disabled = true;

        try {
          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "addHistory", data: lista })
          });
          const dados = await res.json();
          alert(dados.message);
          btn.innerHTML = '<i class="fas fa-check"></i> Concluído';
          btn.style.background = "#2c3e50";
        } catch (e) {
          alert("Erro na conexão.");
          btn.innerHTML = originalContent;
          btn.disabled = false;
        }
      }

      function comunicarAusencia(fullCultoString, event) {
        if (event) event.stopPropagation();
        document.getElementById('displayCultoAviso').innerText = fullCultoString;
        document.getElementById('inputCultoAviso').value = fullCultoString;
        document.getElementById('modalAvisoMembro').style.display = 'flex';
      }

      async function enviarAvisoMembro() {
        const info = document.getElementById('textoAvisoMembro').value.trim();
        const fullCultoString = document.getElementById('inputCultoAviso').value;

        if (!info) return alert("Descreva o motivo do aviso.");

        const userToken = JSON.parse(localStorage.getItem('user_token') || '{}');
        const meuLogin = userToken.Login || userToken.User || "membro";
        const id_Lembrete = 'AVISO-' + Math.random().toString(16).substr(2, 8);

        const payload = {
          action: "addRow",
          sheet: "Lembretes",
          data: {
            id_Lembrete,
            Componente: meuLogin, // Usar Login como solicitado
            Data: new Date().toLocaleDateString('pt-BR'),
            Culto: fullCultoString,
            Info: info
          }
        };

        const btn = document.getElementById('btnEnviarAvisoMembro');
        btn.disabled = true;
        btn.innerText = "ENVIANDO...";

        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          const res = await response.json();
          if (res.status === "success") {
            alert("✅ Aviso enviado!");
            fecharModalAvisoMembro();
            loadAll(true);
          } else {
            alert("⚠️ Erro ao enviar: " + res.message);
          }
        } catch (e) {
          if (window.SyncManager) {
            SyncManager.addToQueue(payload);
            alert("☁️ Offline. O aviso será enviado depois.");
            fecharModalAvisoMembro();
          }
        } finally {
          btn.disabled = false;
          btn.innerText = "ENVIAR AVISO";
        }
      }

      function fecharModalAvisoMembro() {
        document.getElementById('modalAvisoMembro').style.display = 'none';
        document.getElementById('textoAvisoMembro').value = '';
      }
      async function excluirAviso(id_Aviso, event) {
        if (event) event.stopPropagation();
        if (!confirm("Deseja remover este aviso?")) return;

        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: "delete",
              sheet: "Lembretes",
              id_Lembrete: id_Aviso
            })
          });
          const res = await response.json();
          if (res.status === "success") {
            alert("✅ Aviso removido!");
            loadAll(true);
          } else {
            alert("âš ï¸ Erro ao remover: " + res.message);
          }
        } catch (e) {
          alert("âŒ Erro de conexÃ£o.");
        }
      }

      async function excluirMusica(musica, cultoData, cantor) {
        if (!confirm(`Deseja remover "${musica}"?`)) return;
        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "delete", sheet: "Repertório", musica: musica, culto: cultoData, cantor: cantor })
          });
          const res = await response.json();
          if (res.status === "success") { alert("Removido!"); loadAll(true); }
        } catch (e) { setTimeout(() => loadAll(true), 1500); }
      }

      function filterEscala() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.accordion-item').forEach(item => {
          item.classList.toggle('hidden', !item.getAttribute('data-search').includes(q));
        });
      }

      function navigateToAddRepertorio(culto) {
        const searchVal = document.getElementById('searchInput').value;
        let url = `Cadastro de Repertorio.html?culto=${encodeURIComponent(culto)}`;
        const sourceUrl = `Escalas.html?search=${encodeURIComponent(searchVal)}`;
        url += `&source=${encodeURIComponent(sourceUrl)}`;
        window.location.href = url;
      }

      function confirmarTema() {
        localStorage.setItem('tema_escolhido_id', tempThemeId);
        toggleThemePanel();
        if (window.aplicarTemaAtual) aplicarTemaAtual();
      }

      loadAll();
    </script>

  </div>
  </div>
</body>

</html>