<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escala e Repert√≥rio</title>
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <script src="sync.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #3498db;
      --bg: #f4f7f6;
      --music-bg: #fdf2e9;
      --music-text: #e67e22;
      --danger: #e74c3c;
      --success: #27ae60;
      /* Cores dos √≠cones */
      --yt: #ff0000;
      --sp: #1db954;
      --cf: #f1c40f;
      --lt: #3498db;
    }

    /* Estilo comum para todos os √≠cones da lista */
    .member-item i {
      font-size: 1.2rem;
      filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.2));
    }

    /* Cores espec√≠ficas baseadas na categoria */
    .member-item i.Viol√£o {
      color: #e67e22;
    }

    /* Laranja */
    .member-item i.Guitarra {
      color: #e74c3c;
    }

    /* Vermelho/Coral */
    .member-item i.Baixo {
      color: #9b59b6;
    }

    /* Roxo */

    /* Outras cores do gr√°fico */
    .member-item i.Ministro {
      color: #3498db;
    }

    /* Azul */
    .member-item i.Back {
      color: #1abc9c;
    }

    /* Ciano */
    .member-item i.Teclado {
      color: #f1c40f;
    }

    /* Amarelo */
    .member-item i.Bateria {
      color: #2ecc71;
    }

    /* Verde */

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 0;
    }

    .search-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #fff;
      padding: 10px 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #searchInput {
      flex-grow: 1;
      display: block;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 30px;
      outline: none;
    }

    .nav-btn {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--primary);
      transition: transform 0.2s;
      padding: 5px;
    }

    .nav-btn:active {
      transform: scale(0.9);
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
    }

    .accordion-item {
      background: #fff;
      margin-bottom: 15px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      border-left: 6px solid var(--accent);
    }

    .accordion-header {
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-info h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--primary);
    }

    .header-info span {
      font-size: 0.85rem;
      color: #7f8c8d;
    }

    /* Estilo do bot√£o Add All integrado */
    .btn-add-bulk {
      background: var(--success);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.7rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: 0.3s;
      margin-left: 10px;
    }

    .btn-add-bulk:hover {
      background: #219150;
      transform: scale(1.05);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: #fafafa;
    }

    .active .accordion-content {
      max-height: 2000px;
    }

    .active .icon-arrow {
      transform: rotate(180deg);
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
      border-top: 1px solid #eee;
    }

    .section-title-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
      color: #95a5a6;
    }

    .member-item {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #f1f1f1;
      font-size: 0.9rem;
    }

    .member-item i {
      width: 25px;
      color: var(--accent);
    }

    .member-info {
      display: flex;
      justify-content: space-between;
      flex-grow: 1;
    }

    .m-funcao {
      font-size: 0.7rem;
      color: #999;
    }

    .btn-ausencia {
      background: #fdf2f2;
      color: #e74c3c;
      border: 1px solid #fadbd8;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      cursor: pointer;
      margin-left: 10px;
      transition: 0.2s;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .btn-ausencia:hover {
      background: #e74c3c;
      color: white;
    }

    .musica-item {
      background: var(--music-bg);
      color: #5d4037;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      border-left: 4px solid var(--music-text);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .m-nome-musica {
      font-weight: 600;
      color: #2d3436;
      padding-right: 30px;
      margin-bottom: 4px;
    }

    .m-cantor {
      font-size: 0.8rem;
      color: #d35400;
      font-style: italic;
    }

    .m-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }

    .m-tom {
      font-weight: bold;
      color: #2c3e50;
      font-size: 0.75rem;
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #eee;
    }

    .m-links {
      display: flex;
      gap: 10px;
      font-size: 1rem;
    }

    .m-links a {
      text-decoration: none;
      transition: 0.2s;
    }

    .m-links a:hover {
      transform: scale(1.2);
    }

    .l-yt {
      color: var(--yt);
    }

    .l-cf {
      color: var(--cf);
      filter: drop-shadow(0 0 1px #000);
    }

    .l-sp {
      color: var(--sp);
    }

    .l-lt {
      color: var(--lt);
    }

    .btn-del-musica {
      position: absolute;
      right: 8px;
      top: 8px;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.3s;
    }

    .btn-del-musica:hover {
      color: var(--danger);
    }

    .icon-arrow {
      transition: transform 0.3s;
    }

    .hidden {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #888;
    }

    @media (max-width: 600px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    /* LANDSCAPE OPTIMIZATION */
    @media (min-width: 800px) {
      #escala-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        align-items: flex-start;
      }

      .container {
        max-width: 1000px;
      }
    }
  </style>
</head>

<body>

  <div class="search-container">
    <button class="nav-btn" onclick="window.location.href='MenuEscalas.html'" title="Voltar"><i
        class="fas fa-arrow-left"></i></button>
    <input type="text" id="searchInput" placeholder="Pesquisar..." onkeyup="filterEscala()">
    <button class="nav-btn" onclick="loadAll(true)" title="Atualizar Dados"><i class="fas fa-sync-alt"></i></button>
  </div>

  <div id="loader" class="loading" style="display:none"><i class="fas fa-sync fa-spin"></i> Carregando Escalas...</div>
  <div id="escala-container" class="container"></div>

  <script>
    const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;
    const urlEscala = SCRIPT_URL + "?sheet=Transformar";
    const urlRepertorio = SCRIPT_URL + "?sheet=Repert√≥rio";
    const urlLembretes = SCRIPT_URL + "?sheet=Lembretes";

    const iconsMap = {
      "Ministro": "fa-microphone-lines",
      "Back": "fa-microphone",
      "Viol√£o": "fa-guitar",
      "Guitarra": "fa-guitar",
      "Teclado": "fa-keyboard",
      "Bateria": "fa-drum",
      "Baixo": "fa-guitar"
    };
    async function loadAll(forceUpdate = false) {
      const loader = document.getElementById('loader');
      const cachedEscala = localStorage.getItem('offline_escala');
      const cachedRepertorio = localStorage.getItem('offline_repertorio');
      const cachedLembretes = localStorage.getItem('offline_lembretes');

      if (!forceUpdate && cachedEscala && cachedRepertorio && cachedLembretes) {
        renderMaster(JSON.parse(cachedEscala), JSON.parse(cachedRepertorio), JSON.parse(cachedLembretes));
        setTimeout(() => silentSync(), 500);
        return;
      }

      loader.style.display = 'block';
      loader.innerHTML = '<i class="fas fa-sync fa-spin"></i> Atualizando dados...';

      try {
        const [resEscala, resRepertorio, resLembretes] = await Promise.all([
          fetch(urlEscala), fetch(urlRepertorio), fetch(urlLembretes)
        ]);
        const escalaJson = await resEscala.json();
        const repertorioJson = await resRepertorio.json();
        const lembretesJson = await resLembretes.json();

        localStorage.setItem('offline_escala', JSON.stringify(escalaJson.data));
        localStorage.setItem('offline_repertorio', JSON.stringify(repertorioJson.data));
        localStorage.setItem('offline_lembretes', JSON.stringify(lembretesJson.data));

        loader.style.display = 'none';
        renderMaster(escalaJson.data, repertorioJson.data, lembretesJson.data);
        if (forceUpdate) alert("Escalas atualizadas!");
      } catch (e) {
        if (cachedEscala && cachedRepertorio) renderMaster(JSON.parse(cachedEscala), JSON.parse(cachedRepertorio), JSON.parse(cachedLembretes || '[]'));
        else loader.innerText = "Erro ao carregar dados.";
      }
    }

    async function silentSync() {
      try {
        const [resEscala, resRepertorio, resLembretes] = await Promise.all([
          fetch(urlEscala), fetch(urlRepertorio), fetch(urlLembretes)
        ]);
        const escalaJson = await resEscala.json();
        const repertorioJson = await resRepertorio.json();
        const lembretesJson = await resLembretes.json();

        localStorage.setItem('offline_escala', JSON.stringify(escalaJson.data));
        localStorage.setItem('offline_repertorio', JSON.stringify(repertorioJson.data));
        localStorage.setItem('offline_lembretes', JSON.stringify(lembretesJson.data));

        // S√≥ renderiza se n√£o houver busca ativa E nenhum accordion aberto
        const hasActiveItems = document.querySelector('.accordion-item.active') !== null;
        if (document.getElementById('searchInput').value === "" && !hasActiveItems) {
          renderMaster(escalaJson.data, repertorioJson.data, lembretesJson.data);
        }
      } catch (e) { console.log("Silent sync failed"); }
    }

    function renderMaster(escalas, musicas, lembretes = []) {
      const container = document.getElementById('escala-container');
      container.innerHTML = '';
      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

      const escalaAgrupada = escalas.reduce((acc, item) => {
        const dataItem = new Date(item.Data);
        if (dataItem >= hoje) {
          const key = item.Cultos;
          if (!acc[key]) acc[key] = { info: item, membros: [] };
          acc[key].membros.push({ nome: item.Nome, funcao: item["Fun√ß√£o"] });
        }
        return acc;
      }, {});

      const repertorioAgrupado = musicas.reduce((acc, item) => {
        const key = item["Culto+Data"];
        if (!acc[key]) acc[key] = [];
        acc[key].push(item);
        return acc;
      }, {});

      const escalasFiltradas = Object.values(escalaAgrupada).sort((a, b) => new Date(a.info.Data) - new Date(b.info.Data));

      if (escalasFiltradas.length === 0) {
        container.innerHTML = '<div class="loading">N√£o h√° cultos agendados.</div>';
        return;
      }

      escalasFiltradas.forEach(item => {
        const key = item.info.Cultos;
        const dataObj = new Date(item.info.Data);
        // Remove a v√≠rgula do formato: ex "dom. 18/01"
        const dataFormatada = dataObj.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' }).replace(',', '');
        const dataAvisoCheck = dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        const dataFullFormatada = dataObj.toLocaleDateString('pt-BR');
        const musicasDoCulto = repertorioAgrupado[key] || [];

        // Filtrar lembretes deste culto espec√≠fico (Aproximado por dd/mm + Nome do Culto)
        const avisosDoCulto = lembretes.filter(l => {
          const matchData = l.Culto && l.Culto.includes(dataAvisoCheck);
          const matchNome = l.Culto && l.Culto.toLowerCase().includes(item.info["Nome dos Cultos"].toLowerCase().trim());
          return matchData && matchNome;
        });

        // Verifica se o usu√°rio logado est√° escalado neste culto
        const userToken = JSON.parse(localStorage.getItem('user_token') || '{}');
        const meuNomeLogado = (userToken.Nome || "").toLowerCase().trim();
        const estouEscalado = meuNomeLogado && item.membros.some(m => m.nome.toLowerCase().trim().includes(meuNomeLogado));

        const itemEl = document.createElement('div');
        itemEl.className = 'accordion-item';
        itemEl.setAttribute('data-search', (item.info["Nome dos Cultos"] + " " + item.membros.map(m => m.nome).join(" ")).toLowerCase());

        // Armazena as m√∫sicas para a fun√ß√£o Bulk
        itemEl.dataset.musicas = JSON.stringify(musicasDoCulto.map(m => ({
          musica: m.M√∫sicas, cantor: m.Cantor, tom: m.Tons
        })));

        itemEl.innerHTML = `
        <div class="accordion-header" onclick="this.parentElement.classList.toggle('active')">
          <div class="header-info">
            <h3>${item.info["Nome dos Cultos"]}</h3>
            <span>üìÖ ${dataFormatada}</span>
          </div>
          <i class="fas fa-chevron-down icon-arrow"></i>
        </div>
        <div class="accordion-content">
          <div class="content-grid">
            <div>
              <div class="section-title-container">
                <span class="section-title"><i class="fas fa-users"></i> Equipe</span>
                ${estouEscalado ? `
                  <button class="btn-ausencia" onclick="comunicarAusencia('${dataFormatada}', '${item.info["Nome dos Cultos"]}', event)" title="Comunicar Aviso">
                    <i class="fas fa-bell"></i> Avisos
                  </button>
                ` : ''}
              </div>
        ${item.membros.map(m => {
          const categoria = m.funcao.split(' ')[0]; // Pega "Viol√£o", "Guitarra", etc.
          const iconeBase = iconsMap[categoria] || 'fa-star';

          return `
          <div class="member-item">
            <i class="fa-solid ${iconeBase} ${categoria}"></i>
            <div class="member-info">
                <span class="m-nome">${m.nome}</span>
                <span class="m-funcao">${m.funcao}</span>
            </div>
            </div>`;
        }).join('')}

              ${avisosDoCulto.length > 0 ? `
                <div class="extra-section" style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                  <span class="section-title" style="color:#e74c3c; font-size:0.7rem;"><i class="fas fa-exclamation-circle"></i> Avisos</span>
                  ${avisosDoCulto.map(a => `
                    <div style="font-size:0.8rem; background:#fff5f5; padding:8px; border-radius:5px; margin-top:5px; border-left:3px solid #e74c3c; position:relative;">
                      <b>${a.Componente}:</b> ${a.Info}
                      ${a.Componente.toLowerCase().trim() === meuNomeLogado ? `
                        <i class="fas fa-trash-alt" 
                           onclick="excluirAviso('${a.id_Lembrete}', event)" 
                           style="position:absolute; right:8px; top:8px; color:#e74c3c; cursor:pointer; font-size:0.7rem;"
                           title="Remover Aviso"></i>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
            <div>
              <div class="section-title-container">
                <span class="section-title"><i class="fas fa-music"></i> Repert√≥rio</span>
                ${musicasDoCulto.length > 0 ? `
                  <button class="btn-add-bulk" onclick="processarBulk(this, event)">
                    <i class="fas fa-plus-circle"></i> Add Hist√≥rico
                  </button>
                ` : ''}
              </div>
              <div class="repertorio-list">
                ${musicasDoCulto.length > 0 ? musicasDoCulto.map(m => {
          const queryBusca = encodeURIComponent(`${m.M√∫sicas}`);
          const querySpotify = encodeURIComponent(`${m.M√∫sicas} ${m.Cantor || ''}`);
          return `
                  <div class="musica-item">
                    <span class="m-nome-musica">${m.M√∫sicas}</span>
                    <span class="m-cantor">
                      <i class="fas fa-user-voice" style="font-size: 10px;"></i> ${m.Cantor || 'L√≠der n√£o definido'}
                    </span>
                    <div class="m-footer">
                      ${m.Tons ? `<span class="m-tom">${m.Tons}</span>` : '<span class="m-tom">--</span>'}
                      <div class="m-links">
                        <a href="https://www.youtube.com/results?search_query=${queryBusca}" target="_blank" class="l-yt" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://open.spotify.com/search/${querySpotify}" target="_blank" class="l-sp" title="Spotify"><i class="fab fa-spotify"></i></a>
                        <a href="https://www.cifraclub.com.br/?q=${queryBusca}" target="_blank" class="l-cf" title="Cifra Club"><i class="fas fa-guitar"></i></a>
                        <a href="https://www.letras.mus.br/?q=${queryBusca}" target="_blank" class="l-lt" title="Letras.mus"><i class="fas fa-align-left"></i></a>
                      </div>
                    </div>
                    <button class="btn-del-musica" onclick="excluirMusica('${m.M√∫sicas.replace(/'/g, "\\'")}', '${key}', '${m.Cantor.replace(/'/g, "\\'")}')" title="Excluir">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>`;
        }).join('') : '<span style="color:#ccc; font-size:0.85rem">Aguardando repert√≥rio...</span>'}
              </div>
            </div>
          </div>
        </div>
      `;
        container.appendChild(itemEl);
      });
    }

    // --- FUN√á√ïES DE HIST√ìRICO BULK ---
    function processarBulk(btn, event) {
      event.stopPropagation(); // Evita que o accordion feche ao clicar no bot√£o
      const item = btn.closest('.accordion-item');
      const musicas = item.dataset.musicas;
      addBulkHistorico(btn, musicas);
    }

    async function addBulkHistorico(btn, jsonStr) {
      if (!confirm("Adicionar todas as m√∫sicas deste culto ao hist√≥rico? (Duplicatas ser√£o ignoradas)")) return;

      const lista = JSON.parse(jsonStr);
      const originalContent = btn.innerHTML;

      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      btn.disabled = true;

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: "addHistory", data: lista })
        });
        const dados = await res.json();
        alert(dados.message);
        btn.innerHTML = '<i class="fas fa-check"></i> Conclu√≠do';
        btn.style.background = "#2c3e50";
      } catch (e) {
        alert("Erro na conex√£o.");
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    }

    async function comunicarAusencia(dataCulto, nomeCulto, event) {
      event.stopPropagation();
      const userToken = JSON.parse(localStorage.getItem('user_token') || '{}');
      const meuNome = userToken.Nome || "Membro";

      const info = prompt(`Ol√° ${meuNome}, qual aviso voc√™ deseja comunicar para o culto do dia ${dataCulto} (${nomeCulto}):`);

      if (!info || info.trim() === "") return;

      const id_Lembrete = Math.random().toString(16).slice(2, 10);
      const payload = {
        sheet: "Lembretes",
        id_Lembrete,
        Componente: meuNome,
        Data: new Date().toLocaleDateString('pt-BR'),
        Culto: `${nomeCulto} (${dataCulto})`,
        Info: info
      };

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const res = await response.json();
        if (res.status === "success") {
          alert("‚úÖ Aviso enviado com sucesso! Os Componentes ser√£o notificados.");
        } else {
          alert("‚ö†Ô∏è Erro ao enviar: " + res.message);
        }
      } catch (e) {
        // Fallback para persist√™ncia offline via SyncManager se dispon√≠vel
        if (window.SyncManager) {
          SyncManager.addToQueue(payload);
          alert("‚òÅÔ∏è Voc√™ est√° offline. O aviso ser√° enviado assim que houver conex√£o.");
        } else {
          alert("‚ùå Erro de conex√£o. Tente novamente mais tarde.");
        }
      }
    }

    async function excluirAviso(id_Aviso, event) {
      if (event) event.stopPropagation();
      if (!confirm("Deseja remover este aviso?")) return;

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: "delete",
            sheet: "Lembretes",
            id_Lembrete: id_Aviso
          })
        });
        const res = await response.json();
        if (res.status === "success") {
          alert("‚úÖ Aviso removido!");
          loadAll(true);
        } else {
          alert("‚ö†Ô∏è Erro ao remover: " + res.message);
        }
      } catch (e) {
        alert("‚ùå Erro de conex√£o.");
      }
    }

    async function excluirMusica(musica, cultoData, cantor) {
      if (!confirm(`Deseja remover "${musica}"?`)) return;
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: "delete", sheet: "Repert√≥rio", musica: musica, culto: cultoData, cantor: cantor })
        });
        const res = await response.json();
        if (res.status === "success") { alert("Removido!"); loadAll(true); }
      } catch (e) { setTimeout(() => loadAll(true), 1500); }
    }

    function filterEscala() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.accordion-item').forEach(item => {
        item.classList.toggle('hidden', !item.getAttribute('data-search').includes(q));
      });
    }

    window.onload = () => loadAll();
  </script>

</body>

</html>