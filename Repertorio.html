<!DOCTYPE html>
<html lang="pt-br">

<head>
  <script src="temas-lista.js"></script>
  <script src="temas-core.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Repertório</title>
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #27ae60;
      --bg: #f4f7f6;
      --danger: #e74c3c;
      --history: #3498db;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      padding-top: 80px;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      background: var(--glass, rgba(255, 255, 255, 0.9));
      backdrop-filter: blur(12px);
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      height: 70px;
    }

    .header-left-nav,
    .header-right-nav {
      display: flex;
      gap: 0px;
      align-items: center;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      flex-grow: 1;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.8;
    }

    .nav-btn {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor: pointer;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      text-decoration: none;
      font-size: 1.2rem;
    }

    .nav-btn:active {
      transform: scale(0.9);
    }

    /* THEME PANEL */
    .theme-panel {
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 24px;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      z-index: 10001;
      max-width: 240px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.05);
      animation: slideIn 0.3s ease-out;
    }

    .theme-panel h3 {
      margin-top: 0;
      font-weight: 800;
      font-size: 1rem;
      color: #000 !important;
    }

    .theme-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .theme-btn-circ {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: 0.3s;
    }

    .theme-btn-circ.active {
      border-color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
    }

    .apply-btn {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: #2c3e50;
      color: white;
      font-weight: 700;
      cursor: pointer;
    }

    @keyframes slideIn {
      from {
        transform: translateX(50px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Estilo do Grupo (Culto) */
    .culto-group {
      margin-bottom: 15px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .culto-header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.3s;
    }

    .culto-header:hover {
      background: #34495e;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-grow: 1;
    }

    .header-left h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .data-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    /* Controles da Direita (BotÃ£o + Seta) */
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .btn-add-all {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: bold;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-add-all:hover {
      background: #219150;
      transform: scale(1.05);
    }

    .arrow-icon {
      transition: 0.3s;
      font-size: 0.9rem;
    }

    /* Accordion Control */
    .culto-body {
      display: none;
      padding: 5px 0;
    }

    .culto-group.active .culto-body {
      display: block;
    }

    .culto-group.active .arrow-icon {
      transform: rotate(180deg);
    }

    /* Estilo da MÃºsica */
    .musica-item {
      display: grid;
      grid-template-columns: 2fr 0.8fr 1.5fr 80px;
      padding: 12px 20px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }

    .musica-item:last-child {
      border-bottom: none;
    }

    .m-nome {
      font-weight: 600;
      color: #333;
    }

    .m-tom span {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.8rem;
    }

    .m-cantor {
      color: #666;
      font-size: 0.85rem;
      padding-left: 10px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    .btn-action {
      background: none;
      border: none;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1.1rem;
      padding: 5px;
      color: #ccc;
    }

    .btn-history:hover {
      color: var(--history);
    }

    .btn-delete:hover {
      color: var(--danger);
    }

    .btn-history.saved {
      color: var(--accent) !important;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #666;
    }

    @media (max-width: 600px) {
      .musica-item {
        grid-template-columns: 1fr 0.5fr 1fr 70px;
        padding: 10px;
        font-size: 0.8rem;
      }

      .btn-add-all span {
        display: none;
      }

      /* Esconde texto no mobile, deixa sÃ³ Ã­cone */
    }

    /* LANDSCAPE OPTIMIZATION */
    @media (min-width: 900px) {
      #repertorioAgrupado {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        align-items: flex-start;
      }

      .container {
        max-width: 1200px;
      }
    }
  </style>
</head>

<body style="padding-top: 80px;">

  <div class="header-bar">
    <div class="header-left-nav">
      <i class="fas fa-arrow-left nav-btn" onclick="window.location.href='MenuMusicas.html'" title="Voltar"></i>
      <i class="fas fa-home nav-btn" onclick="window.location.href='index.html'" title="Início"></i>
    </div>
    <h2 class="header-title">Cronograma</h2>
    <div class="header-right-nav">
      <i class="fas fa-palette nav-btn" onclick="toggleThemePanel()" title="Trocar Tema"></i>
      <i class="fas fa-sync-alt nav-btn" onclick="carregarRepertorio(true)" title="Sincronizar"></i>
    </div>
  </div>

  <div id="themePanel" class="theme-panel">
    <h3>Escolha um Tema</h3>
    <div class="theme-buttons" id="themeButtonsGrid"></div>
    <button class="apply-btn" onclick="confirmarTema()">USAR ESTE TEMA</button>
  </div>

  <div class="container" style="padding: 20px 15px;">

    <div id="repertorioAgrupado">
      <div id="loader" class="loading" style="display:none"><i class="fas fa-spinner fa-spin"></i> Carregando escalas...
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="sync.js"></script>
  <script>
    const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;

    async function carregarRepertorio(force = false) {
      const container = document.getElementById('repertorioAgrupado');
      const loader = document.getElementById('loader');
      const cached = localStorage.getItem('offline_repertorio');

      // Se tem cache e nÃ£o Ã© forÃ§ado, renderiza e busca em silÃªncio
      if (!force && cached) {
        render(JSON.parse(cached));
        setTimeout(() => silentSync(), 500);
        return;
      }

      loader.style.display = 'block';
      loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';

      try {
        const response = await fetch(SCRIPT_URL + "?sheet=Repertório");
        const json = await response.json();
        localStorage.setItem('offline_repertorio', JSON.stringify(json.data));
        render(json.data);
        loader.style.display = 'none';
        if (force) alert("Atualizado!");
      } catch (e) {
        if (cached) render(JSON.parse(cached));
        else container.innerHTML = '<div class="loading">Erro ao carregar dados.</div>';
      }
    }

    async function silentSync() {
      try {
        const response = await fetch(SCRIPT_URL + "?sheet=Repertório");
        const json = await response.json();
        localStorage.setItem('offline_repertorio', JSON.stringify(json.data));

        // SÃ³ renderiza se nÃ£o houver busca ativa E nenhum item aberto (para nÃ£o fechar na cara do usuÃ¡rio)
        const hasActiveItems = document.querySelector('.active') !== null;
        if (SyncManager.getQueue().length === 0 && !hasActiveItems) {
          render(json.data);
        }
      } catch (e) { console.log("Silent sync failed"); }
    }

    // Ouvinte para re-renderizar quando a sincronizaÃ§Ã£o terminar
    window.addEventListener('syncCompleted', () => carregarRepertorio());

    function render(data) {
      const container = document.getElementById('repertorioAgrupado');
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="loading">Nenhum repertório encontrado.</div>';
        return;
      }

      const dadosOrdenados = data.sort((a, b) => new Date(b.Data) - new Date(a.Data));
      const grupos = {};
      dadosOrdenados.forEach(item => {
        const chave = item["Culto+Data"];
        if (!grupos[chave]) {
          grupos[chave] = { nome: item.Culto, dataFull: item.Data, musicas: [] };
        }
        grupos[chave].musicas.push(item);
      });

      container.innerHTML = '';

      for (let chave in grupos) {
        const grupo = grupos[chave];
        const d = new Date(grupo.dataFull);
        const dataFmt = ("0" + d.getUTCDate()).slice(-2) + "/" + ("0" + (d.getUTCMonth() + 1)).slice(-2) + "/" + d.getUTCFullYear();

        const section = document.createElement('div');
        section.className = 'culto-group';

        // Forma segura de armazenar os dados para o botÃ£o Add All
        section.dataset.musicas = JSON.stringify(grupo.musicas.map(m => ({
          musica: m.Músicas, cantor: m.Cantor, tom: m.Tons
        })));

        section.innerHTML = `
          <div class="culto-header">
            <div class="header-left" onclick="toggleAccordion(this)">
              <span class="data-badge">${dataFmt}</span>
              <h3>${grupo.nome}</h3>
            </div>
            <div class="header-right">
              <button class="btn-add-all" onclick="processarBulk(this)">
                <i class="fas fa-plus-circle"></i> <span>Add Histórico</span>
              </button>
              <i class="fas fa-chevron-down arrow-icon" onclick="toggleAccordion(this)"></i>
            </div>
          </div>
          <div class="culto-body">
            ${grupo.musicas.map(m => `
              <div class="musica-item">
                <div class="m-nome">${m.Músicas}</div>
                <div class="m-tom"><span>${m.Tons || '--'}</span></div>
                <div class="m-cantor"><i class="fas fa-user"></i> ${m.Cantor}</div>
                <div class="actions">
                  <button class="btn-action btn-history" onclick="addHistorico(this, '${m.Músicas.replace(/'/g, "\\'")}', '${m.Cantor.replace(/'/g, "\\'")}', '${m.Tons}')">
                    <i class="fas fa-bookmark"></i>
                  </button>
                  <button class="btn-action btn-delete" onclick="excluir('${m.Músicas.replace(/'/g, "\\'")}', '${chave}', '${m.Cantor.replace(/'/g, "\\'")}')">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        container.appendChild(section);
      }
    }

    // Nova função para o botão Add All ler os dados do dataset
    function processarBulk(btn) {
      const section = btn.closest('.culto-group');
      const musicas = section.dataset.musicas;
      addBulkHistorico(btn, musicas);
    }
    function toggleAccordion(el) {
      el.closest('.culto-group').classList.toggle('active');
    }

    async function addHistorico(btn, musica, cantor, tom) {
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: "addHistory", musica, cantor, tom })
        });
        const dados = await res.json();
        if (dados.status === "success") {
          btn.innerHTML = '<i class="fas fa-check"></i>';
          btn.classList.add('saved');
        } else {
          alert(dados.message);
          btn.innerHTML = '<i class="fas fa-bookmark"></i>';
        }
      } catch (e) { btn.innerHTML = '<i class="fas fa-bookmark"></i>'; }
    }

    async function addBulkHistorico(btn, jsonStr) {
      if (!confirm("Adicionar todas as músicas deste culto ao histórico? (Duplicatas serão ignoradas)")) return;
      const lista = JSON.parse(jsonStr);
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: "addHistory", data: lista })
        });
        const dados = await res.json();
        alert(dados.message);
      } catch (e) { alert("Erro na conexão."); }

      btn.innerHTML = original;
      btn.disabled = false;
    }

    async function excluir(musica, culto, cantor) {
      if (!confirm("Deseja realmente excluir esta música do repertório?")) return;

      const payload = { action: "delete", sheet: "Repertório", musica, culto, cantor };

      // 1. Atualiza UI imediatamente (Otimismo)
      SyncManager.updateLocalCache("Repertório", "delete", payload);
      render(JSON.parse(localStorage.getItem('offline_repertorio')));

      // 2. Adiciona Ã  fila de sincronizaÃ§Ã£o
      SyncManager.addToQueue(payload);
    }

    window.onload = () => carregarRepertorio();
  </script>

  </div>
</body>

</html>