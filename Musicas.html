<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/Font Awesome/css/all.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #e67e22;
      --bg: #fdfdfd;
      --yt: #ff0000;
      --sp: #1db954;
      --cf: #f1c40f;
      --lt: #3498db;
      --danger: #e74c3c;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
    }

    .header-bar {
      background: var(--glass);
      backdrop-filter: blur(12px);
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
      flex-grow: 1;
      text-align: center;
    }

    .nav-btn {
      background: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* Acordeão de Temas */
    .tema-section {
      margin-bottom: 15px;
      border-radius: var(--radius-lg);
      background: white;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.02);
      overflow: hidden;
    }

    .tema-header {
      background: var(--primary);
      color: white;
      padding: 18px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.1rem;
      font-weight: 700;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .tema-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: white;
    }

    /* Acordeão de Estilos */
    .estilo-section {
      border-bottom: 1px solid #eee;
    }

    .estilo-header {
      padding: 14px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
      color: var(--text-main);
      font-weight: 700;
      font-size: 0.9rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .estilo-header .count {
      background: white;
      color: var(--primary);
      padding: 2px 10px;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 800;
      box-shadow: var(--shadow-sm);
    }

    .estilo-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    /* Grid de Músicas */
    .music-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      padding: 15px 5px;
    }

    .music-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .music-info h3 {
      margin: 0;
      font-size: 1rem;
      color: #333;
      padding-right: 25px;
    }

    .music-info p {
      margin: 5px 0 12px 0;
      color: #7f8c8d;
      font-size: 0.8rem;
    }

    /* Botão de Excluir Música da Biblioteca */
    .btn-del-lib {
      position: absolute;
      right: 10px;
      top: 12px;
      background: none;
      border: none;
      color: #ddd;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn-del-lib:hover {
      color: var(--danger);
    }

    /* Botões de Ação */
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
    }

    .btn {
      text-align: center;
      padding: 6px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 0.7rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: white;
    }

    .btn-yt {
      background: var(--yt);
    }

    .btn-sp {
      background: var(--sp);
    }

    .btn-cf {
      background: var(--cf);
      color: #333;
    }

    .btn-lt {
      background: var(--lt);
    }

    /* Classes de Controle */
    .open>.tema-content,
    .open>.estilo-content {
      max-height: 5000px;
      transition: max-height 1s ease-in;
    }

    .open>.tema-header .arrow,
    .open>.estilo-header .arrow {
      transform: rotate(180deg);
    }

    .arrow {
      transition: transform 0.3s;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #999;
    }

    .hidden {
      display: none !important;
    }

    /* LANDSCAPE OPTIMIZATION */
    @media (min-width: 800px) {
      #main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        align-items: flex-start;
      }

      .container {
        max-width: 1100px;
      }
    }

    /* ANALYTICS */
    .analytics-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .stat-val {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-lbl {
      font-size: 0.7rem;
      color: #7f8c8d;
      text-transform: uppercase;
    }

    .chart-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .chart-wrapper {
      position: relative;
      height: 180px;
      width: 100%;
    }

    @media (max-width: 600px) {
      .analytics-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <div class="header-bar">
    <button class="nav-btn" onclick="window.location.href='MenuMusicas.html'" title="Voltar">
      <i class="fas fa-arrow-left"></i>
    </button>
    <h2 class="header-title">Lista de Músicas</h2>
    <button class="nav-btn btn-update" onclick="loadData(true)" title="Atualizar Dados">
      <i class="fas fa-sync-alt"></i>
    </button>
  </div>

  <div class="search-container"
    style="padding: 15px; background: var(--glass); backdrop-filter: blur(8px); border-bottom: 1px solid #f1f5f9; position: fixed; top: 70px; left:0; right:0; z-index: 999;">
    <div style="max-width: 500px; margin: 0 auto;">
      <input type="text" id="searchInput" placeholder="Pesquisar música ou artista..." onkeyup="filterMusics()"
        class="premium-input" style="margin-bottom: 0; box-shadow: var(--shadow-sm);">
    </div>
  </div>

  <div class="premium-container" style="max-width: 1100px; padding-top: 170px;">

    <div id="loader" class="loading" style="display:none"><i class="fas fa-list-ul fa-spin"></i> Organizando por Tema e
      Estilo...</div>

    <div id="main-content" class="container" style="margin-top: 5px;"></div>

    <script>
      const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;
      const urlGet = SCRIPT_URL + "?sheet=Musicas";

      async function loadData(force = false) {
        const loader = document.getElementById('loader');
        const cached = localStorage.getItem('offline_musicas');

        // Se tem cache e não for forçado pelo botão, mostra logo e atualiza quieto
        if (!force && cached) {
          renderAccordion(JSON.parse(cached));
          // Sincronização silenciosa em background após carregar o cache
          setTimeout(() => silentSync(), 500);
          return;
        }

        // Se for forçado (botão) ou não tiver cache, mostra loader
        const btnIcon = document.querySelector('.btn-update i');
        if (btnIcon) btnIcon.classList.add('spin');

        loader.style.display = 'block';
        loader.innerHTML = '<i class="fas fa-sync fa-spin"></i> Atualizando...';

        try {
          const response = await fetch(urlGet);
          const json = await response.json();
          localStorage.setItem('offline_musicas', JSON.stringify(json.data));
          renderAccordion(json.data);
          loader.style.display = 'none';
          if (force) alert("Lista de músicas atualizada!");
        } catch (e) {
          loader.innerText = "Erro ao conectar.";
          if (cached) renderAccordion(JSON.parse(cached));
        } finally {
          if (btnIcon) btnIcon.classList.remove('spin');
        }
      }

      async function silentSync() {
        try {
          const response = await fetch(urlGet);
          const json = await response.json();
          localStorage.setItem('offline_musicas', JSON.stringify(json.data));

          // Só renderiza se não houver busca ativa E nenhum item aberto
          const hasOpenItems = document.querySelector('.open') !== null;
          if (document.getElementById('searchInput').value === "" && !hasOpenItems) {
            renderAccordion(json.data);
          }
        } catch (e) { console.log("Silent sync failed"); }
      }

      function renderAccordion(data) {
        const container = document.getElementById('main-content');
        container.innerHTML = '';

        const grouped = data.reduce((acc, m) => {
          const t = m.Tema || "Geral";
          const e = m.Estilo || "Outros";
          if (!acc[t]) acc[t] = {};
          if (!acc[t][e]) acc[t][e] = [];
          acc[t][e].push(m);
          return acc;
        }, {});

        for (const tema in grouped) {
          const temaSection = document.createElement('div');
          temaSection.className = 'tema-section';
          temaSection.innerHTML = `
        <div class="tema-header" onclick="toggle(this.parentElement)">
          <span><i class="fas fa-folder"></i> ${tema}</span>
          <i class="fas fa-chevron-down arrow"></i>
        </div>
        <div class="tema-content"></div>
      `;

          const temaContent = temaSection.querySelector('.tema-content');

          for (const estilo in grouped[tema]) {
            const estiloSection = document.createElement('div');
            estiloSection.className = 'estilo-section';
            estiloSection.innerHTML = `
          <div class="estilo-header" onclick="toggle(this.parentElement)">
            <span>${estilo}</span>
            <i class="fas fa-chevron-down arrow"></i>
          </div>
          <div class="estilo-content">
            <div class="music-grid"></div>
          </div>
        `;

            const grid = estiloSection.querySelector('.music-grid');

            grouped[tema][estilo].forEach(m => {
              // GERAÇÃO AUTOMÁTICA DOS LINKS DE BUSCA
              const query = encodeURIComponent(`${m.Músicas} ${m.Cantor}`);
              const linkYT = `https://www.youtube.com/results?search_query=${query}`;
              const linkCF = `https://www.cifraclub.com.br/?q=${query}`;
              const linkSP = `https://open.spotify.com/search/${query}`;
              const linkLT = `https://www.letras.mus.br/?q=${query}`;

              const card = document.createElement('div');
              card.className = 'premium-card';
              card.style.padding = '15px';
              card.style.position = 'relative';
              card.setAttribute('data-search', `${m.Músicas} ${m.Cantor}`.toLowerCase());
              card.innerHTML = `
            <button class="btn-del-lib" onclick="excluirDaBiblioteca('${m.Músicas}', '${m.Cantor}')" title="Excluir">
              <i class="fas fa-trash-alt"></i>
            </button>
            <div class="music-info">
              <h3 class="font-heading" style="font-size: 1rem; margin-bottom: 4px; padding-right: 25px;">${m.Músicas}</h3>
              <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;"><i class="fas fa-microphone me-1"></i> ${m.Cantor}</p>
            </div>
            <div class="actions">
              <a href="${linkYT}" target="_blank" class="btn btn-yt"><i class="fab fa-youtube"></i> Video</a>
              <a href="${linkCF}" target="_blank" class="btn btn-cf"><i class="fas fa-guitar"></i> Cifra</a>
              <a href="${linkSP}" target="_blank" class="btn btn-sp"><i class="fab fa-spotify"></i> Play</a>
              <a href="${linkLT}" target="_blank" class="btn btn-lt"><i class="fas fa-align-left"></i> Letra</a>
            </div>
          `;
              grid.appendChild(card);
            });
            temaContent.appendChild(estiloSection);
          }
          container.appendChild(temaSection);
        }
      }

      async function excluirDaBiblioteca(musica, cantor) {
        if (!confirm(`Deseja remover "${musica}" da biblioteca permanentemente?`)) return;

        // Encontrar o cartão da música para dar feedback visual imediato
        const cards = document.querySelectorAll('.music-card');
        let cardToRemove = null;
        for (let card of cards) {
          const searchData = card.getAttribute('data-search');
          if (searchData.includes(musica.toLowerCase()) && searchData.includes(cantor.toLowerCase())) {
            cardToRemove = card;
            break;
          }
        }

        if (cardToRemove) {
          // Estado de "Excluindo..."
          cardToRemove.style.opacity = '0.5';
          cardToRemove.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c; font-weight:bold;"><i class="fas fa-spinner fa-spin"></i> Excluindo...</div>';
        }

        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "delete", sheet: "Musicas", musica: musica, cantor: cantor })
          });
          const res = await response.json();
          if (res.status === "success") {
            if (cardToRemove) {
              // Animação final de sumir
              cardToRemove.style.transition = 'all 0.5s';
              cardToRemove.style.transform = 'scale(0)';
              setTimeout(() => cardToRemove.remove(), 500);
            } else {
              loadData();
            }
          }
        } catch (e) {
          // Se der erro, recarrega tudo para garantir consistência
          setTimeout(() => loadData(), 1500);
        }
      }

      function toggle(el) { el.classList.toggle('open'); }

      function filterMusics() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.music-card');
        const sections = document.querySelectorAll('.tema-section, .estilo-section');

        if (q === "") {
          sections.forEach(s => { s.classList.remove('open', 'hidden'); });
          cards.forEach(c => c.classList.remove('hidden'));
          return;
        }

        cards.forEach(card => {
          const match = card.getAttribute('data-search').includes(q);
          card.classList.toggle('hidden', !match);
        });

        document.querySelectorAll('.estilo-section').forEach(es => {
          const hasVisible = es.querySelectorAll('.music-card:not(.hidden)').length > 0;
          es.classList.toggle('hidden', !hasVisible);
          if (hasVisible) es.classList.add('open');
        });

        document.querySelectorAll('.tema-section').forEach(ts => {
          const hasVisible = ts.querySelectorAll('.estilo-section:not(.hidden)').length > 0;
          ts.classList.toggle('hidden', !hasVisible);
          if (hasVisible) ts.classList.add('open');
        });
      }

      window.onload = () => loadData();
    </script>

  </div>
</body>

</html>